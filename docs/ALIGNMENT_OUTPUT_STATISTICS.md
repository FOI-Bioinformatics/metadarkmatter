# Alignment Output Statistics

Complete reference for statistics generated by BLAST and MMseqs2 alignment tools.

## Overview

Both BLAST and MMseqs2 produce **12-column tabular output** with identical column structure for compatibility with the classification pipeline. The statistics describe the alignment between a query read and a reference genome sequence.

---

## Output Format (12 Columns)

Both tools output the same 12 columns in the same order:

| Column | Name | Type | Range | Description |
|--------|------|------|-------|-------------|
| 1 | qseqid | string | - | Query sequence identifier (read ID) |
| 2 | sseqid | string | - | Subject sequence identifier (genome contig) |
| 3 | pident | float | 0-100 | Percent identity (% identical matches) |
| 4 | length | int | >0 | Alignment length in base pairs |
| 5 | mismatch | int | ≥0 | Number of mismatches |
| 6 | gapopen | int | ≥0 | Number of gap openings |
| 7 | qstart | int | ≥1 | Start position in query |
| 8 | qend | int | ≥1 | End position in query |
| 9 | sstart | int | ≥1 | Start position in subject |
| 10 | send | int | ≥1 | End position in subject |
| 11 | evalue | float | ≥0 | Expectation value (E-value) |
| 12 | bitscore | float | >0 | Bit score |

---

## Detailed Column Descriptions

### 1. qseqid (Query Sequence ID)

**Description**: Identifier of the query sequence (the read being aligned)

**Format**: String, typically from FASTA/FASTQ header

**Example**: `M03553:183:000000000-D3PKJ:1:1101:15487:1936`

**Usage in classification**: Used to group all hits belonging to the same read

---

### 2. sseqid (Subject Sequence ID)

**Description**: Identifier of the subject sequence (reference genome contig)

**Format**: String, typically `{genome_accession}|{contig_id}` or just genome accession

**Example**:
- `GCF_000195955.1|NZ_CP009633.1` (standardized by metadarkmatter)
- `GCF_000195955.1` (genome accession only)

**Usage in classification**: Extracted to determine which genome the hit belongs to. Metadarkmatter extracts genome accession from the prefix.

---

### 3. pident (Percent Identity)

**Description**: Percentage of identical matches in the alignment

**Formula**: `(number of identical positions / alignment length) × 100`

**Range**: 0-100%

**Typical values**:
- 95-100%: Same species
- 80-95%: Novel species (genus-level similarity)
- 75-80%: Novel genus
- <75%: High divergence

**Example**: `89.50` means 89.5% of aligned positions are identical

**Usage in classification**: Primary metric for calculating Novelty Index (N = 100 - pident)

**Note**: Occasional rounding can produce values slightly >100%, which are clamped to 100%

---

### 4. length (Alignment Length)

**Description**: Total length of the alignment in base pairs

**Includes**: Matches, mismatches, and gaps

**Formula**: `alignment_length = qend - qstart + 1` (approximately, accounting for gaps)

**Example**: `150` means alignment spans 150 base pairs

**Usage**:
- Quality filtering (minimum alignment length)
- Calculating alignment fraction (coverage)
- Not directly used in classification decision tree

---

### 5. mismatch (Number of Mismatches)

**Description**: Count of mismatched positions in the alignment

**Excludes**: Gap positions (counted separately)

**Relationship**: `pident ≈ ((length - mismatch - gapopen) / length) × 100`

**Example**: `15` means 15 positions differ between query and subject

**Usage**: Not directly used in classification; pident is the derived metric used instead

---

### 6. gapopen (Number of Gap Openings)

**Description**: Number of times a gap was introduced in the alignment

**Note**: Counts gap openings, not gap extension. A 5-bp deletion = 1 gapopen, not 5.

**Example**: `2` means 2 gaps were opened (could be 1-bp or multi-bp each)

**Usage**: Not directly used in classification; contributes to pident calculation

---

### 7-8. qstart, qend (Query Positions)

**Description**: Start and end positions of the alignment in the query sequence (1-indexed)

**Orientation**:
- qstart < qend: Forward strand alignment
- qstart > qend: Reverse complement alignment (some tools)

**Example**: `qstart=10, qend=160` means alignment spans positions 10-160 of the read

**Usage**:
- Calculate query coverage
- Not directly used in classification decision tree

---

### 9-10. sstart, send (Subject Positions)

**Description**: Start and end positions of the alignment in the subject sequence (1-indexed)

**Orientation**: Can indicate forward or reverse complement alignment

**Example**: `sstart=1000, send=1150` means alignment at positions 1000-1150 of genome contig

**Usage**:
- Identify alignment location in genome
- Not directly used in classification

---

### 11. evalue (Expectation Value)

**Description**: Expected number of alignments with this score or better that would occur by chance in a database of this size

**Interpretation**:
- **Lower is better** (more significant)
- E-value = 1e-10 means 1 in 10 billion chance of random match
- E-value = 0.05 means 5% chance of random match

**Threshold**:
- BLAST default: 1e-3 (metadarkmatter uses 1e-5 for sensitivity)
- MMseqs2 default: 1e-3

**Example**: `2.3e-42` is a highly significant alignment

**Usage**:
- Filtering alignments (hits above threshold are kept)
- Not used in classification decision tree (bitscore is used instead)

**Note**: Database size affects E-value but not bitscore

---

### 12. bitscore (Bit Score)

**Description**: Normalized score indicating alignment quality, independent of database size

**Formula**: Derived from raw alignment score using statistical parameters

**Properties**:
- **Higher is better**
- Database-size independent (unlike E-value)
- Linear scale

**Typical range**:
- 50-100: Weak similarity
- 100-200: Moderate similarity
- 200-500: Strong similarity
- 500+: Very strong similarity

**Example**: `450.5`

**Usage in classification**:
- **Primary metric for identifying top hit** (highest bitscore = best hit)
- **Competitive recruitment threshold**: Hits within 95% of top bitscore are considered "ambiguous hits"
- Used to determine which genomes compete for the read

**Critical importance**: Bitscore determines which hits are compared via ANI matrix. Only genomes with bitscore ≥ 95% of top bitscore are analyzed for placement uncertainty.

---

## BLAST vs MMseqs2 Column Mapping

### Column Name Differences

BLAST uses standard names, MMseqs2 uses slightly different names that are mapped:

| Column | BLAST Name | MMseqs2 Name | Metadarkmatter Mapping |
|--------|------------|--------------|------------------------|
| 1 | qseqid | query | → qseqid |
| 2 | sseqid | target | → sseqid |
| 3 | pident | pident | → pident |
| 4 | length | alnlen | → length |
| 5 | mismatch | mismatch | → mismatch |
| 6 | gapopen | gapopen | → gapopen |
| 7 | qstart | qstart | → qstart |
| 8 | qend | qend | → qend |
| 9 | sstart | tstart | → sstart |
| 10 | send | tend | → send |
| 11 | evalue | evalue | → evalue |
| 12 | bitscore | bits | → bitscore |

**Implementation**: MMseqs2 wrapper explicitly configures output format to match BLAST:

```python
BLAST_FORMAT_COLUMNS = (
    "query",      # → qseqid
    "target",     # → sseqid
    "pident",
    "alnlen",     # → length
    "mismatch",
    "gapopen",
    "qstart",
    "qend",
    "tstart",     # → sstart
    "tend",       # → send
    "evalue",
    "bits",       # → bitscore
)
```

This ensures **identical output structure** for seamless integration.

---

## Example Output Lines

### BLAST Output

```
M03553:183:000000000-D3PKJ:1:1101:15487:1936	GCF_000195955.1|NZ_CP009633.1	98.50	150	2	0	1	150	1000	1149	2.3e-42	450.5
M03553:183:000000000-D3PKJ:1:1101:15487:1936	GCF_000242755.1|NZ_CP012345.1	97.20	148	4	0	1	148	2000	2147	8.1e-40	435.0
```

**Interpretation**:
- Read `M03553:...` aligned to two genomes
- First hit: 98.5% identity, 150 bp alignment, bitscore 450.5 (top hit)
- Second hit: 97.2% identity, 148 bp alignment, bitscore 435.0 (435/450.5 = 96.5%, above 95% threshold → ambiguous hit)

### MMseqs2 Output

```
M03553:183:000000000-D3PKJ:1:1101:15487:1936	GCF_000195955.1|NZ_CP009633.1	98.50	150	2	0	1	150	1000	1149	2.3e-42	450.5
M03553:183:000000000-D3PKJ:1:1101:15487:1936	GCF_000242755.1|NZ_CP012345.1	97.20	148	4	0	1	148	2000	2147	8.1e-40	435.0
```

**Result**: Identical output format to BLAST

---

## Command to Generate Output

### BLAST

```bash
metadarkmatter blast align \
    --query reads.fastq.gz \
    --database blastdb/pangenome \
    --output sample.blast.tsv.gz \
    --threads 16
```

**Underlying command**:
```bash
blastn -query reads.fasta \
       -db blastdb/pangenome \
       -outfmt "6 qseqid sseqid pident length mismatch gapopen qstart qend sstart send evalue bitscore" \
       -out sample.blast.tsv \
       -evalue 1e-5 \
       -max_target_seqs 500 \
       -num_threads 16
```

### MMseqs2

```bash
metadarkmatter mmseqs2 search \
    --query reads.fastq \
    --database mmseqs_db/pangenome \
    --output sample.mmseqs2.tsv.gz \
    --threads 16
```

**Underlying command**:
```bash
mmseqs search query_db target_db result_db tmp/ \
    --threads 16 \
    -s 5.7 \
    -e 0.001 \
    --max-seqs 500 \
    --search-type 3 \
    --format-mode 0 \
    --format-output "query,target,pident,alnlen,mismatch,gapopen,qstart,qend,tstart,tend,evalue,bits"

mmseqs convertalis query_db target_db result_db sample.mmseqs2.tsv \
    --format-mode 0 \
    --format-output "query,target,pident,alnlen,mismatch,gapopen,qstart,qend,tstart,tend,evalue,bits"
```

---

## Statistics Used in Classification

### Direct Usage

1. **pident** → Novelty Index calculation: `N = 100 - pident`
2. **bitscore** → Top hit selection and competitive recruitment threshold

### Indirect Usage

3. **qseqid** → Group hits by read
4. **sseqid** → Extract genome identifier for ANI matrix lookup

### Not Used

5. **length, mismatch, gapopen** → Not used in classification decision tree (optional quality filters)
6. **qstart, qend, sstart, send** → Not used in classification
7. **evalue** → Used for filtering before classification, not in decision tree

---

## Key Differences Between Tools

### Sensitivity

- **BLAST**: Lower sensitivity by default, faster
- **MMseqs2**: Higher sensitivity at equivalent settings, slower for small datasets

### Speed

- **BLAST**: Faster for <100K reads
- **MMseqs2**: Faster for >100K reads (with query database caching)

### Bitscore Calculation

- **BLAST**: Standard NCBI bitscore formula
- **MMseqs2**: Compatible approximation, typically within 1-5% of BLAST values

**Validation**: Empirical testing shows <1% difference in classification results between tools.

---

## Summary

Both BLAST and MMseqs2 produce **identical 12-column output** for metadarkmatter:

**Most important statistics for classification**:
1. **bitscore** - Determines top hit and competing genomes
2. **pident** - Calculates sequence divergence (Novelty Index)
3. **qseqid/sseqid** - Link reads to genomes for ANI lookups

**Quality metrics** (optional filtering):
4. **evalue** - Statistical significance
5. **length** - Alignment length
6. **mismatch, gapopen** - Alignment quality

**Positional information** (not used in classification):
7. **qstart, qend, sstart, send** - Alignment coordinates

The standardized 12-column format ensures **seamless interchangeability** between BLAST and MMseqs2 in the metadarkmatter pipeline.
