"""
HTML template strings for report generation.

Uses Python string formatting instead of Jinja2 to minimize dependencies.
All templates produce self-contained HTML with embedded CSS and JS.
"""

from __future__ import annotations

# =============================================================================
# Main Report Template
# =============================================================================

REPORT_BASE_TEMPLATE: str = '''<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    <style>
{css_styles}
    </style>
</head>
<body>
    <header class="report-header">
        <h1>{title}</h1>
        <div class="metadata">
            <span>Sample: <strong>{sample_name}</strong></span>
            <span>Generated: <strong>{timestamp}</strong></span>
            <span>Total Reads: <strong>{total_reads}</strong></span>
        </div>
    </header>

    <nav class="tab-navigation">
        <button class="tab-btn active" onclick="showTab('overview')">Overview</button>
        <button class="tab-btn" onclick="showTab('distributions')">Distributions</button>
        <button class="tab-btn" onclick="showTab('recruitment')">Recruitment</button>
        <button class="tab-btn" onclick="showTab('species')">Species</button>
        <button class="tab-btn" onclick="showTab('genomes')">Genomes</button>
        <button class="tab-btn" onclick="showTab('ani')">ANI Matrix</button>
        <button class="tab-btn" onclick="showTab('aai')">AAI Matrix</button>
        <button class="tab-btn" onclick="showTab('data')">Data</button>
    </nav>

    <main class="report-content">
{content}
    </main>

    <footer class="report-footer">
        <p>Generated by <strong>Metadarkmatter</strong> v{version}</p>
        <p>ANI-weighted taxonomic placement for metagenomic analysis</p>
    </footer>

    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
{plotly_js}
    <script>
{js_scripts}
    </script>
</body>
</html>
'''

# =============================================================================
# Section Templates
# =============================================================================

TAB_SECTION_TEMPLATE: str = '''
<section id="{tab_id}" class="tab-section {active_class}">
    <h2 class="section-title">{section_title}</h2>
    {content}
</section>
'''

# =============================================================================
# Metric Cards
# =============================================================================

METRIC_CARDS_CONTAINER: str = '''
<div class="metric-cards">
{cards}
</div>
'''

METRIC_CARD_TEMPLATE: str = '''
<div class="metric-card">
    <div class="metric-value {color_class}">{value}</div>
    <div class="metric-label">{label}</div>
    <div class="metric-subtext">{subtext}</div>
</div>
'''

# =============================================================================
# Diversity Summary (Hero Section)
# =============================================================================

DIVERSITY_SUMMARY_TEMPLATE: str = '''
<div class="diversity-summary">
    <div class="diversity-headline">
        <div class="headline-value novel">{novel_pct:.1f}%</div>
        <div class="headline-label">Novel Diversity Detected</div>
        <div class="headline-detail">{novel_count:,} reads represent potentially new taxa</div>
    </div>
    <div class="diversity-cards">
        <div class="diversity-card known">
            <div class="diversity-pct">{known_pct:.1f}%</div>
            <div class="diversity-label">Known</div>
            <div class="diversity-count">{known_count:,} reads</div>
            <div class="diversity-desc">Match known species in database</div>
        </div>
        <div class="diversity-card novel">
            <div class="diversity-pct">{novel_pct:.1f}%</div>
            <div class="diversity-label">Novel</div>
            <div class="diversity-count">{novel_count:,} reads</div>
            <div class="diversity-desc">Potential new species or genera</div>
        </div>
        <div class="diversity-card uncertain">
            <div class="diversity-pct">{uncertain_pct:.1f}%</div>
            <div class="diversity-label">Uncertain</div>
            <div class="diversity-count">{uncertain_count:,} reads</div>
            <div class="diversity-desc">Ambiguous placement, needs review</div>
        </div>
    </div>
    <div class="diversity-bar">
        <div class="bar-segment known" style="width: {known_pct}%;" title="Known: {known_pct:.1f}%"></div>
        <div class="bar-segment novel" style="width: {novel_pct}%;" title="Novel: {novel_pct:.1f}%"></div>
        <div class="bar-segment uncertain" style="width: {uncertain_pct}%;" title="Uncertain: {uncertain_pct:.1f}%"></div>
    </div>
    <div class="diversity-bar-legend">
        <span class="legend-item"><span class="legend-dot known"></span> Known</span>
        <span class="legend-item"><span class="legend-dot novel"></span> Novel</span>
        <span class="legend-item"><span class="legend-dot uncertain"></span> Uncertain</span>
    </div>
</div>
'''

CATEGORY_BREAKDOWN_TEMPLATE: str = '''
<div class="category-breakdown">
    <h3 class="breakdown-title">Classification Details</h3>
    <div class="breakdown-explanation">
        <p>Reads are classified based on sequence identity and placement confidence:</p>
    </div>
    <div class="breakdown-grid">
        <div class="breakdown-group known">
            <div class="group-header">
                <span class="group-dot known"></span>
                <span class="group-name">Known Diversity</span>
            </div>
            <div class="category-item">
                <span class="cat-name">Known Species</span>
                <span class="cat-count">{known_species:,}</span>
                <span class="cat-pct">{known_species_pct:.1f}%</span>
            </div>
            <div class="category-desc">High identity (>95%) to reference genomes</div>
        </div>
        <div class="breakdown-group novel">
            <div class="group-header">
                <span class="group-dot novel"></span>
                <span class="group-name">Novel Diversity</span>
            </div>
            <div class="category-item">
                <span class="cat-name">Novel Species</span>
                <span class="cat-count">{novel_species:,}</span>
                <span class="cat-pct">{novel_species_pct:.1f}%</span>
            </div>
            <div class="category-item">
                <span class="cat-name">Novel Genus</span>
                <span class="cat-count">{novel_genus:,}</span>
                <span class="cat-pct">{novel_genus_pct:.1f}%</span>
            </div>
            <div class="category-desc">85-95% identity suggests new species; 75-85% suggests new genus</div>
        </div>
        <div class="breakdown-group uncertain">
            <div class="group-header">
                <span class="group-dot uncertain"></span>
                <span class="group-name">Uncertain Classification</span>
            </div>
            <div class="category-item">
                <span class="cat-name">Species Boundary</span>
                <span class="cat-count">{species_boundary:,}</span>
                <span class="cat-pct">{species_boundary_pct:.1f}%</span>
            </div>
            <div class="category-item">
                <span class="cat-name">Ambiguous</span>
                <span class="cat-count">{ambiguous:,}</span>
                <span class="cat-pct">{ambiguous_pct:.1f}%</span>
            </div>
            <div class="category-item">
                <span class="cat-name">Conserved Region</span>
                <span class="cat-count">{conserved_regions:,}</span>
                <span class="cat-pct">{conserved_pct:.1f}%</span>
            </div>
            <div class="category-desc">Multiple competing matches or conserved genes shared across taxa</div>
        </div>
    </div>
</div>
'''

# =============================================================================
# Distributions Tab Templates
# =============================================================================

DISTRIBUTIONS_SUMMARY_TEMPLATE: str = '''
<div class="distributions-summary">
    <div class="dist-intro">
        <h3>Understanding Your Sample</h3>
        <p>These distributions reveal the taxonomic composition and confidence of classifications.
           The scatter plot below is the key diagnostic - it shows where each read falls in
           novelty-uncertainty space.</p>
    </div>
    <div class="dist-metrics">
        <div class="dist-metric">
            <div class="dist-metric-value">{mean_identity:.1f}%</div>
            <div class="dist-metric-label">Mean Identity</div>
            <div class="dist-metric-hint">Sequence similarity to references</div>
        </div>
        <div class="dist-metric">
            <div class="dist-metric-value">{mean_novelty:.1f}</div>
            <div class="dist-metric-label">Mean Novelty</div>
            <div class="dist-metric-hint">{novelty_interpretation}</div>
        </div>
        <div class="dist-metric">
            <div class="dist-metric-value">{mean_uncertainty:.1f}</div>
            <div class="dist-metric-label">Mean Uncertainty</div>
            <div class="dist-metric-hint">{uncertainty_interpretation}</div>
        </div>
        <div class="dist-metric">
            <div class="dist-metric-value">{confident_pct:.0f}%</div>
            <div class="dist-metric-label">Confident Calls</div>
            <div class="dist-metric-hint">Low uncertainty placements</div>
        </div>
    </div>
</div>
'''

SCATTER_INTERPRETATION_TEMPLATE: str = '''
<div class="scatter-interpretation">
    <h4>Reading the Scatter Plot</h4>
    <div class="interpretation-grid">
        <div class="interp-region known">
            <div class="region-marker"></div>
            <div class="region-text">
                <strong>Bottom-Left: Known Species</strong>
                <span>Low novelty + low uncertainty = confident match to known taxa</span>
            </div>
        </div>
        <div class="interp-region novel">
            <div class="region-marker"></div>
            <div class="region-text">
                <strong>Bottom-Right: Novel Diversity</strong>
                <span>High novelty + low uncertainty = potential new species/genus</span>
            </div>
        </div>
        <div class="interp-region uncertain">
            <div class="region-marker"></div>
            <div class="region-text">
                <strong>Top Region: Uncertain</strong>
                <span>High uncertainty = ambiguous placement or conserved genes</span>
            </div>
        </div>
    </div>
</div>
'''

# =============================================================================
# Genomes Tab Templates
# =============================================================================

GENOMES_SUMMARY_TEMPLATE: str = '''
<div class="genomes-summary">
    <div class="genomes-intro">
        <h3>Reference Genome Analysis</h3>
        <p>Reads are assigned to their best-matching reference genome. This breakdown shows
           which genomes in your database are most represented and how confident the assignments are.</p>
    </div>
    <div class="genomes-metrics">
        <div class="genome-metric">
            <div class="genome-metric-value">{total_genomes}</div>
            <div class="genome-metric-label">Genomes Hit</div>
            <div class="genome-metric-hint">Out of {ref_genomes} in database</div>
        </div>
        <div class="genome-metric highlight">
            <div class="genome-metric-value">{top_genome_pct:.0f}%</div>
            <div class="genome-metric-label">Top Genome</div>
            <div class="genome-metric-hint">{top_genome_name}</div>
        </div>
        <div class="genome-metric">
            <div class="genome-metric-value">{top3_pct:.0f}%</div>
            <div class="genome-metric-label">Top 3 Genomes</div>
            <div class="genome-metric-hint">{concentration_hint}</div>
        </div>
        <div class="genome-metric">
            <div class="genome-metric-value">{median_reads}</div>
            <div class="genome-metric-label">Median Reads</div>
            <div class="genome-metric-hint">Per genome</div>
        </div>
    </div>
</div>
'''

GENOME_HIGHLIGHTS_TEMPLATE: str = '''
<div class="genome-highlights">
    <h4>Key Genomes</h4>
    <div class="highlights-grid">
        <div class="highlight-card top">
            <div class="highlight-icon">1</div>
            <div class="highlight-content">
                <div class="highlight-title">Most Abundant</div>
                <div class="highlight-species">{top_species}</div>
                <div class="highlight-accession">{top_accession}</div>
                <div class="highlight-stats">
                    <span class="stat">{top_reads:,} reads</span>
                    <span class="stat">{top_identity:.1f}% identity</span>
                </div>
            </div>
        </div>
        <div class="highlight-card novel">
            <div class="highlight-icon">N</div>
            <div class="highlight-content">
                <div class="highlight-title">Most Novel</div>
                <div class="highlight-species">{novel_species}</div>
                <div class="highlight-accession">{novel_accession}</div>
                <div class="highlight-stats">
                    <span class="stat">{novel_reads:,} reads</span>
                    <span class="stat">{novel_novelty:.1f} novelty</span>
                </div>
            </div>
        </div>
        <div class="highlight-card confident">
            <div class="highlight-icon">C</div>
            <div class="highlight-content">
                <div class="highlight-title">Most Confident</div>
                <div class="highlight-species">{confident_species}</div>
                <div class="highlight-accession">{confident_accession}</div>
                <div class="highlight-stats">
                    <span class="stat">{confident_reads:,} reads</span>
                    <span class="stat">{confident_identity:.1f}% identity</span>
                </div>
            </div>
        </div>
    </div>
</div>
'''

GENOME_INTERPRETATION_TEMPLATE: str = '''
<div class="genome-interpretation">
    <h4>Understanding Genome Distribution</h4>
    <div class="interp-items">
        <div class="interp-item">
            <span class="interp-label">Concentrated distribution</span>
            <span class="interp-desc">Most reads hit few genomes - sample likely contains organisms closely related to specific references</span>
        </div>
        <div class="interp-item">
            <span class="interp-label">Spread distribution</span>
            <span class="interp-desc">Reads spread across many genomes - may indicate diverse community or novel organism equidistant from multiple references</span>
        </div>
        <div class="interp-item">
            <span class="interp-label">Low identity hits</span>
            <span class="interp-desc">Genomes with lower mean identity suggest reads from more divergent organisms</span>
        </div>
    </div>
</div>
'''

# =============================================================================
# Plot Containers
# =============================================================================

PLOT_ROW_TEMPLATE: str = '''
<div class="plot-row">
{plots}
</div>
'''

PLOT_CONTAINER_TEMPLATE: str = '''
<div class="plot-container {extra_class}">
    <div class="plot-title">{title}</div>
    <div class="plot-description">{description}</div>
    <div id="{plot_id}" class="plotly-chart"></div>
</div>
'''

PLOT_CONTAINER_SIMPLE_TEMPLATE: str = '''
<div class="plot-container {extra_class}">
    <div id="{plot_id}" class="plotly-chart"></div>
</div>
'''

# =============================================================================
# Data Table
# =============================================================================

DATA_SUMMARY_TEMPLATE: str = '''
<div class="data-summary">
    <div class="data-intro">
        <h3>Classification Data</h3>
        <p>Detailed per-read classification results. Use filters to explore specific categories
           or search for individual reads. Click column headers to sort.</p>
    </div>
    <div class="data-stats">
        <div class="data-stat">
            <span class="stat-value">{total_rows:,}</span>
            <span class="stat-label">Total Reads</span>
        </div>
        <div class="data-stat known">
            <span class="stat-value">{known_count:,}</span>
            <span class="stat-label">Known</span>
        </div>
        <div class="data-stat novel">
            <span class="stat-value">{novel_count:,}</span>
            <span class="stat-label">Novel</span>
        </div>
        <div class="data-stat uncertain">
            <span class="stat-value">{uncertain_count:,}</span>
            <span class="stat-label">Uncertain</span>
        </div>
    </div>
</div>
'''

DATA_QUICK_FILTERS_TEMPLATE: str = '''
<div class="quick-filters">
    <span class="filter-label">Quick filters:</span>
    <button class="filter-chip all active" onclick="quickFilter('')">All</button>
    <button class="filter-chip known" onclick="quickFilter('Known Species')">Known Species ({known_count})</button>
    <button class="filter-chip novel-species" onclick="quickFilter('Novel Species')">Novel Species ({novel_species_count})</button>
    <button class="filter-chip novel-genus" onclick="quickFilter('Novel Genus')">Novel Genus ({novel_genus_count})</button>
    <button class="filter-chip ambiguous" onclick="quickFilter('Ambiguous')">Ambiguous ({ambiguous_count})</button>
    <button class="filter-chip conserved" onclick="quickFilter('Conserved Region')">Conserved ({conserved_count})</button>
</div>
'''

DATA_COLUMN_GUIDE_TEMPLATE: str = '''
<details class="column-guide">
    <summary>Column Guide</summary>
    <div class="guide-content">
        <div class="guide-item">
            <span class="guide-col">Identity %</span>
            <span class="guide-desc">Sequence similarity to best-matching reference (higher = more similar)</span>
        </div>
        <div class="guide-item">
            <span class="guide-col">Novelty</span>
            <span class="guide-desc">100 - Identity%. Higher values suggest more divergent/novel sequences</span>
        </div>
        <div class="guide-item">
            <span class="guide-col">Uncertainty</span>
            <span class="guide-desc">ANI-based placement confidence. Low = confident, High = ambiguous between references</span>
        </div>
        <div class="guide-item">
            <span class="guide-col">Classification</span>
            <span class="guide-desc">Final taxonomic call based on novelty and uncertainty thresholds</span>
        </div>
    </div>
</details>
'''

DATA_TABLE_TEMPLATE: str = '''
<div class="table-container">
    <div class="table-controls">
        <div class="controls-row">
            <input type="text" class="table-search" id="tableSearch"
                   placeholder="Search reads, genomes, species..." oninput="filterTable()">
            <div class="controls-right">
                <div class="column-selector">
                    <button class="column-btn" onclick="toggleColumnMenu()">Columns</button>
                    <div class="column-menu" id="columnMenu">
                        <div class="menu-header">Show/Hide Columns</div>
                        <label><input type="checkbox" data-col="0" checked onchange="toggleColumn(0)"> Read ID</label>
                        <label><input type="checkbox" data-col="1" checked onchange="toggleColumn(1)"> Best Match</label>
                        <label><input type="checkbox" data-col="2" onchange="toggleColumn(2)"> Species</label>
                        <label><input type="checkbox" data-col="3" onchange="toggleColumn(3)"> Genus</label>
                        <label><input type="checkbox" data-col="4" checked onchange="toggleColumn(4)"> Identity %</label>
                        <label><input type="checkbox" data-col="5" checked onchange="toggleColumn(5)"> Novelty</label>
                        <label><input type="checkbox" data-col="6" checked onchange="toggleColumn(6)"> Uncertainty</label>
                        <label><input type="checkbox" data-col="7" onchange="toggleColumn(7)"> Ambiguous Hits</label>
                        <label><input type="checkbox" data-col="8" onchange="toggleColumn(8)"> Identity Gap</label>
                        <label><input type="checkbox" data-col="9" onchange="toggleColumn(9)"> Is Novel</label>
                        <label><input type="checkbox" data-col="10" checked onchange="toggleColumn(10)"> Classification</label>
                    </div>
                </div>
                <button class="export-btn" onclick="exportTableTSV()">Export TSV</button>
            </div>
        </div>
        <div class="filter-status" id="filterStatus">
            <span class="results-count">Showing <strong id="resultsCount">{total_rows:,}</strong> reads</span>
            <button class="clear-btn" id="clearFilters" onclick="clearAllFilters()" style="display:none;">Clear filters</button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="data-table" id="dataTable">
            <thead>
                <tr>
                    <th data-col="0" onclick="sortTable(0)">Read ID <span class="sort-icon">-</span></th>
                    <th data-col="1" onclick="sortTable(1)">Best Match <span class="sort-icon">-</span></th>
                    <th data-col="2" onclick="sortTable(2)" style="display:none;">Species <span class="sort-icon">-</span></th>
                    <th data-col="3" onclick="sortTable(3)" style="display:none;">Genus <span class="sort-icon">-</span></th>
                    <th data-col="4" onclick="sortTable(4)">Identity % <span class="sort-icon">-</span></th>
                    <th data-col="5" onclick="sortTable(5)">Novelty <span class="sort-icon">-</span></th>
                    <th data-col="6" onclick="sortTable(6)">Uncertainty <span class="sort-icon">-</span></th>
                    <th data-col="7" onclick="sortTable(7)" style="display:none;">Ambig. Hits <span class="sort-icon">-</span></th>
                    <th data-col="8" onclick="sortTable(8)" style="display:none;">Identity Gap <span class="sort-icon">-</span></th>
                    <th data-col="9" onclick="sortTable(9)" style="display:none;">Is Novel <span class="sort-icon">-</span></th>
                    <th data-col="10" onclick="sortTable(10)">Classification <span class="sort-icon">-</span></th>
                </tr>
            </thead>
            <tbody id="tableBody">
{table_rows}
            </tbody>
        </table>
    </div>
    <div class="table-pagination">
        <span class="page-info" id="pageInfo">Showing 1-{page_size} of {total_rows}</span>
        <div class="page-buttons">
            <button class="page-btn" id="prevBtn" onclick="prevPage()" disabled>Previous</button>
            <span class="page-number" id="pageNumber">Page 1</span>
            <button class="page-btn" id="nextBtn" onclick="nextPage()">Next</button>
        </div>
    </div>
</div>
'''

TABLE_ROW_TEMPLATE: str = '''<tr class="data-row" data-class="{classification}">
    <td data-col="0">{read_id}</td>
    <td data-col="1">{best_match}</td>
    <td data-col="2" style="display:none;">{species}</td>
    <td data-col="3" style="display:none;">{genus}</td>
    <td data-col="4">{identity:.2f}</td>
    <td data-col="5">{novelty:.2f}</td>
    <td data-col="6">{uncertainty:.2f}</td>
    <td data-col="7" style="display:none;">{ambiguous_hits}</td>
    <td data-col="8" style="display:none;">{identity_gap}</td>
    <td data-col="9" style="display:none;">{is_novel}</td>
    <td data-col="10" class="{cell_class}">{classification}</td>
</tr>'''

# =============================================================================
# JavaScript
# =============================================================================

TAB_NAVIGATION_JS: str = '''
// Tab navigation
function showTab(tabId) {
    document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');

    // Trigger Plotly resize for proper rendering
    window.dispatchEvent(new Event('resize'));
}
'''

DATA_TABLE_JS: str = '''
// Data table functionality
let currentPage = 1;
const pageSize = {page_size};
let filteredRows = [];
let allRows = [];
let currentClassFilter = '';
let currentSearchFilter = '';

// Column visibility state (stored in localStorage)
const columnNames = ['read_id', 'best_match', 'species', 'genus', 'identity', 'novelty', 'uncertainty', 'ambiguous_hits', 'identity_gap', 'is_novel', 'classification'];
let columnVisibility = [true, true, false, false, true, true, true, false, false, false, true];

document.addEventListener('DOMContentLoaded', function() {{
    allRows = Array.from(document.querySelectorAll('.data-row'));
    filteredRows = [...allRows];

    // Load saved column visibility from localStorage
    const saved = localStorage.getItem('mdm_column_visibility');
    if (saved) {{
        try {{
            columnVisibility = JSON.parse(saved);
            // Apply saved visibility
            columnVisibility.forEach((visible, col) => {{
                const checkbox = document.querySelector(`input[data-col="${{col}}"]`);
                if (checkbox) checkbox.checked = visible;
                applyColumnVisibility(col, visible);
            }});
        }} catch (e) {{
            console.warn('Could not load column preferences');
        }}
    }}

    updatePagination();

    // Close column menu when clicking outside
    document.addEventListener('click', function(e) {{
        const menu = document.getElementById('columnMenu');
        const btn = document.querySelector('.column-btn');
        if (menu && !menu.contains(e.target) && !btn.contains(e.target)) {{
            menu.classList.remove('show');
        }}
    }});
}});

function toggleColumnMenu() {{
    const menu = document.getElementById('columnMenu');
    menu.classList.toggle('show');
}}

function toggleColumn(col) {{
    const checkbox = document.querySelector(`input[data-col="${{col}}"]`);
    const visible = checkbox.checked;
    columnVisibility[col] = visible;

    // Save to localStorage
    localStorage.setItem('mdm_column_visibility', JSON.stringify(columnVisibility));

    applyColumnVisibility(col, visible);
}}

function applyColumnVisibility(col, visible) {{
    // Toggle header
    const header = document.querySelector(`th[data-col="${{col}}"]`);
    if (header) header.style.display = visible ? '' : 'none';

    // Toggle all cells in that column
    document.querySelectorAll(`td[data-col="${{col}}"]`).forEach(cell => {{
        cell.style.display = visible ? '' : 'none';
    }});
}}

function quickFilter(classification) {{
    currentClassFilter = classification;
    currentSearchFilter = document.getElementById('tableSearch').value.toLowerCase();

    // Update chip active states
    document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
    if (!classification) {{
        document.querySelector('.filter-chip.all').classList.add('active');
    }} else {{
        // Find the chip that matches the classification
        document.querySelectorAll('.filter-chip').forEach(chip => {{
            if (chip.textContent.includes(classification.split(' ')[0])) {{
                chip.classList.add('active');
            }}
        }});
    }}

    applyFilters();
}}

function filterTable() {{
    currentSearchFilter = document.getElementById('tableSearch').value.toLowerCase();
    applyFilters();
}}

function applyFilters() {{
    filteredRows = allRows.filter(row => {{
        const text = row.textContent.toLowerCase();
        const rowClass = row.dataset.class;
        const matchSearch = !currentSearchFilter || text.includes(currentSearchFilter);
        const matchClass = !currentClassFilter || rowClass === currentClassFilter;
        return matchSearch && matchClass;
    }});

    currentPage = 1;
    updatePagination();
    updateFilterStatus();
}}

function clearAllFilters() {{
    currentClassFilter = '';
    currentSearchFilter = '';
    document.getElementById('tableSearch').value = '';

    // Reset chip active states
    document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
    document.querySelector('.filter-chip.all').classList.add('active');

    filteredRows = [...allRows];
    currentPage = 1;
    updatePagination();
    updateFilterStatus();
}}

function updateFilterStatus() {{
    const resultsCount = document.getElementById('resultsCount');
    const clearBtn = document.getElementById('clearFilters');

    if (resultsCount) {{
        resultsCount.textContent = filteredRows.length.toLocaleString();
    }}

    const hasFilters = currentClassFilter || currentSearchFilter;
    if (clearBtn) {{
        clearBtn.style.display = hasFilters ? 'inline-block' : 'none';
    }}
}}

function updatePagination() {{
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const totalPages = Math.ceil(filteredRows.length / pageSize);

    allRows.forEach(row => row.style.display = 'none');
    filteredRows.slice(start, end).forEach(row => row.style.display = '');

    const showing = Math.min(end, filteredRows.length);
    const pageInfo = document.getElementById('pageInfo');
    if (pageInfo) {{
        pageInfo.textContent = `Showing ${{start + 1}}-${{showing}} of ${{filteredRows.length}}`;
    }}

    const pageNumber = document.getElementById('pageNumber');
    if (pageNumber) {{
        pageNumber.textContent = `Page ${{currentPage}} of ${{totalPages || 1}}`;
    }}

    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = end >= filteredRows.length;
}}

function nextPage() {{
    currentPage++;
    updatePagination();
}}

function prevPage() {{
    currentPage--;
    updatePagination();
}}

let sortColumn = -1;
let sortAsc = true;

function sortTable(col) {{
    if (sortColumn === col) {{
        sortAsc = !sortAsc;
    }} else {{
        sortColumn = col;
        sortAsc = true;
    }}

    filteredRows.sort((a, b) => {{
        const aCell = a.querySelector(`td[data-col="${{col}}"]`);
        const bCell = b.querySelector(`td[data-col="${{col}}"]`);
        if (!aCell || !bCell) return 0;

        const aVal = aCell.textContent;
        const bVal = bCell.textContent;

        // Try numeric comparison
        const aNum = parseFloat(aVal);
        const bNum = parseFloat(bVal);
        if (!isNaN(aNum) && !isNaN(bNum)) {{
            return sortAsc ? aNum - bNum : bNum - aNum;
        }}

        // String comparison
        return sortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    }});

    currentPage = 1;
    updatePagination();

    // Update sort indicators
    document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = '-');
    const header = document.querySelector(`th[data-col="${{col}}"]`);
    if (header) {{
        const icon = header.querySelector('.sort-icon');
        if (icon) icon.textContent = sortAsc ? '^' : 'v';
    }}
}}

function exportTableTSV() {{
    // Export only visible columns
    const visibleCols = columnVisibility.map((v, i) => v ? i : -1).filter(i => i >= 0);
    const headers = visibleCols.map(i => columnNames[i]);

    const rows = filteredRows.map(row => {{
        return visibleCols.map(col => {{
            const cell = row.querySelector(`td[data-col="${{col}}"]`);
            return cell ? cell.textContent : '';
        }}).join('\\t');
    }});

    const tsv = headers.join('\\t') + '\\n' + rows.join('\\n');
    const blob = new Blob([tsv], {{ type: 'text/tab-separated-values' }});
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'classifications_export.tsv';
    a.click();
    URL.revokeObjectURL(url);
}}
'''

# =============================================================================
# Empty/Placeholder Sections
# =============================================================================

EMPTY_SECTION_TEMPLATE: str = '''
<div class="plot-container" style="text-align: center; padding: 3rem;">
    <p style="color: var(--text-muted); font-size: 1rem;">
        {message}
    </p>
</div>
'''

ANI_NOT_PROVIDED_MESSAGE: str = "ANI matrix not provided. Use --ani option to include ANI heatmap."

RECRUITMENT_NOT_PROVIDED_MESSAGE: str = (
    "BAM file not provided. Use --bam option to include recruitment plot."
)


# =============================================================================
# Helper Functions
# =============================================================================

def get_cell_class(classification: str) -> str:
    """Get CSS class for table cell based on classification."""
    class_map = {
        "Known Species": "cell-known",
        "Novel Species": "cell-novel-species",
        "Novel Genus": "cell-novel-genus",
        "Conserved Region": "cell-conserved",
    }
    return class_map.get(classification, "")


def get_metric_color_class(metric_type: str) -> str:
    """Get CSS class for metric card based on type."""
    color_map = {
        "total": "",
        "known": "success",
        "novel_species": "warning",
        "novel_genus": "danger",
        "conserved": "info",
    }
    return color_map.get(metric_type, "")
