"""
HTML template strings for report generation.

Uses Python string formatting instead of Jinja2 to minimize dependencies.
All templates produce self-contained HTML with embedded CSS and JS.
"""

from __future__ import annotations

# =============================================================================
# Main Report Template
# =============================================================================

REPORT_BASE_TEMPLATE: str = '''<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    <style>
{css_styles}
    </style>
</head>
<body>
    <header class="report-header">
        <h1>{title}</h1>
        <div class="metadata">
            <span>Sample: <strong>{sample_name}</strong></span>
            <span>Generated: <strong>{timestamp}</strong></span>
            <span>Total Reads: <strong>{total_reads}</strong></span>
        </div>
    </header>

    <nav class="tab-navigation">
{navigation}
    </nav>

    <main class="report-content">
{content}
    </main>

    <footer class="report-footer">
        <p>Generated by <strong>Metadarkmatter</strong> v{version}</p>
        <p>ANI-weighted taxonomic placement for metagenomic analysis</p>
    </footer>

    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
{plotly_js}
    <script>
{js_scripts}
    </script>
</body>
</html>
'''

# =============================================================================
# Section Templates
# =============================================================================

TAB_SECTION_TEMPLATE: str = '''
<section id="{tab_id}" class="tab-section {active_class}">
    <h2 class="section-title">{section_title}</h2>
    {content}
</section>
'''

# =============================================================================
# Metric Cards
# =============================================================================

METRIC_CARDS_CONTAINER: str = '''
<div class="metric-cards">
{cards}
</div>
'''

METRIC_CARD_TEMPLATE: str = '''
<div class="metric-card">
    <div class="metric-value {color_class}">{value}</div>
    <div class="metric-label">{label}</div>
    <div class="metric-subtext">{subtext}</div>
</div>
'''

# =============================================================================
# Diversity Summary (Hero Section)
# =============================================================================

DIVERSITY_SUMMARY_TEMPLATE: str = '''
<div class="diversity-summary">
    <div class="diversity-headline">
        <div class="headline-value novel">{novel_pct:.1f}%</div>
        <div class="headline-label">Novel Diversity Detected</div>
        <div class="headline-detail">{novel_count:,} reads represent potentially new taxa</div>
    </div>
    <div class="diversity-cards">
        <div class="diversity-card known">
            <div class="diversity-pct">{known_pct:.1f}%</div>
            <div class="diversity-label">Known</div>
            <div class="diversity-count">{known_count:,} reads</div>
            <div class="diversity-desc">Match known species in database</div>
        </div>
        <div class="diversity-card novel">
            <div class="diversity-pct">{novel_pct:.1f}%</div>
            <div class="diversity-label">Novel</div>
            <div class="diversity-count">{novel_count:,} reads</div>
            <div class="diversity-desc">Potential new species or genera</div>
        </div>
        <div class="diversity-card uncertain">
            <div class="diversity-pct">{uncertain_pct:.1f}%</div>
            <div class="diversity-label">Uncertain</div>
            <div class="diversity-count">{uncertain_count:,} reads</div>
            <div class="diversity-desc">Ambiguous placement, needs review</div>
        </div>
{off_target_card}
    </div>
    <div class="diversity-bar">
        <div class="bar-segment known" style="width: {known_pct}%;" title="Known: {known_pct:.1f}%"></div>
        <div class="bar-segment novel" style="width: {novel_pct}%;" title="Novel: {novel_pct:.1f}%"></div>
        <div class="bar-segment uncertain" style="width: {uncertain_pct}%;" title="Uncertain: {uncertain_pct:.1f}%"></div>
{off_target_bar}
    </div>
    <div class="diversity-bar-legend">
        <span class="legend-item"><span class="legend-dot known"></span> Known</span>
        <span class="legend-item"><span class="legend-dot novel"></span> Novel</span>
        <span class="legend-item"><span class="legend-dot uncertain"></span> Uncertain</span>
{off_target_legend}
    </div>
</div>
'''

OVERVIEW_KEY_FINDINGS_TEMPLATE: str = '''
<div class="key-findings">
    <h3 class="findings-title">Key Findings</h3>
    <div class="findings-grid">
        {findings_cards}
    </div>
</div>
'''

OVERVIEW_FINDING_CARD_TEMPLATE: str = '''
<div class="finding-card {card_class}">
    <div class="finding-icon">{icon}</div>
    <div class="finding-content">
        <div class="finding-headline">{headline}</div>
        <div class="finding-detail">{detail}</div>
        {link}
    </div>
</div>
'''

CATEGORY_BREAKDOWN_TEMPLATE: str = '''
<div class="category-breakdown">
    <h3 class="breakdown-title">Classification Details</h3>
    <div class="breakdown-explanation">
        <p>Reads are classified based on sequence identity and placement confidence:</p>
    </div>
    <div class="breakdown-grid">
        <div class="breakdown-group known">
            <div class="group-header">
                <span class="group-dot known"></span>
                <span class="group-name">Known Diversity</span>
            </div>
            <div class="category-item">
                <span class="cat-name">Known Species</span>
                <span class="cat-count">{known_species:,}</span>
                <span class="cat-pct">{known_species_pct:.1f}%</span>
            </div>
            <div class="category-desc">High identity (>95%) to reference genomes</div>
        </div>
        <div class="breakdown-group novel">
            <div class="group-header">
                <span class="group-dot novel"></span>
                <span class="group-name">Novel Diversity</span>
            </div>
            <div class="category-item">
                <span class="cat-name">Novel Species</span>
                <span class="cat-count">{novel_species:,}</span>
                <span class="cat-pct">{novel_species_pct:.1f}%</span>
            </div>
            <div class="category-item">
                <span class="cat-name">Novel Genus</span>
                <span class="cat-count">{novel_genus:,}</span>
                <span class="cat-pct">{novel_genus_pct:.1f}%</span>
            </div>
            <div class="category-desc">85-95% identity suggests new species; 75-85% suggests new genus</div>
        </div>
        <div class="breakdown-group uncertain">
            <div class="group-header">
                <span class="group-dot uncertain"></span>
                <span class="group-name">Uncertain Classification</span>
            </div>
            <div class="category-item">
                <span class="cat-name">Species Boundary</span>
                <span class="cat-count">{species_boundary:,}</span>
                <span class="cat-pct">{species_boundary_pct:.1f}%</span>
            </div>
            <div class="category-item">
                <span class="cat-name">Ambiguous</span>
                <span class="cat-count">{ambiguous:,}</span>
                <span class="cat-pct">{ambiguous_pct:.1f}%</span>
            </div>
            <div class="category-item">
                <span class="cat-name">Conserved Region</span>
                <span class="cat-count">{conserved_regions:,}</span>
                <span class="cat-pct">{conserved_pct:.1f}%</span>
            </div>
            <div class="category-desc">Multiple competing matches or conserved genes shared across taxa</div>
        </div>
    </div>
</div>
'''

# =============================================================================
# Distributions Tab Templates
# =============================================================================

DISTRIBUTIONS_SUMMARY_TEMPLATE: str = '''
<div class="distributions-summary">
    <div class="dist-intro">
        <h3>Understanding Your Sample</h3>
        <p>These distributions reveal the taxonomic composition and confidence of classifications.
           The scatter plot below is the key diagnostic - it shows where each read falls in
           novelty-uncertainty space.</p>
    </div>
    <div class="dist-metrics">
        <div class="dist-metric">
            <div class="dist-metric-value">{mean_identity:.1f}%</div>
            <div class="dist-metric-label">Mean Identity</div>
            <div class="dist-metric-hint">Sequence similarity to references</div>
        </div>
        <div class="dist-metric">
            <div class="dist-metric-value">{mean_novelty:.1f}</div>
            <div class="dist-metric-label">Mean Novelty</div>
            <div class="dist-metric-hint">{novelty_interpretation}</div>
        </div>
        <div class="dist-metric">
            <div class="dist-metric-value">{mean_uncertainty:.1f}</div>
            <div class="dist-metric-label">Mean Uncertainty</div>
            <div class="dist-metric-hint">{uncertainty_interpretation}</div>
        </div>
        <div class="dist-metric">
            <div class="dist-metric-value">{confident_pct:.0f}%</div>
            <div class="dist-metric-label">Confident Calls</div>
            <div class="dist-metric-hint">Low uncertainty placements</div>
        </div>
    </div>
</div>
'''

SCATTER_INTERPRETATION_TEMPLATE: str = '''
<div class="scatter-interpretation">
    <h4>Reading the Scatter Plot</h4>
    <div class="interpretation-grid">
        <div class="interp-region known">
            <div class="region-marker"></div>
            <div class="region-text">
                <strong>Bottom-Left: Known Species</strong>
                <span>Low novelty + low uncertainty = confident match to known taxa</span>
            </div>
        </div>
        <div class="interp-region novel">
            <div class="region-marker"></div>
            <div class="region-text">
                <strong>Bottom-Right: Novel Diversity</strong>
                <span>High novelty + low uncertainty = potential new species/genus</span>
            </div>
        </div>
        <div class="interp-region uncertain">
            <div class="region-marker"></div>
            <div class="region-text">
                <strong>Top Region: Uncertain</strong>
                <span>High uncertainty = ambiguous placement or conserved genes</span>
            </div>
        </div>
    </div>
</div>
'''

# =============================================================================
# Genomes Tab Templates
# =============================================================================

GENOMES_SUMMARY_TEMPLATE: str = '''
<div class="genomes-summary">
    <div class="genomes-intro">
        <h3>Reference Genome Analysis</h3>
        <p>Reads are assigned to their best-matching reference genome. This breakdown shows
           which genomes in your database are most represented and how confident the assignments are.</p>
    </div>
    <div class="genomes-metrics">
        <div class="genome-metric">
            <div class="genome-metric-value">{total_genomes}</div>
            <div class="genome-metric-label">Genomes Hit</div>
            <div class="genome-metric-hint">Out of {ref_genomes} in database</div>
        </div>
        <div class="genome-metric highlight">
            <div class="genome-metric-value">{top_genome_pct:.0f}%</div>
            <div class="genome-metric-label">Top Genome</div>
            <div class="genome-metric-hint">{top_genome_name}</div>
        </div>
        <div class="genome-metric">
            <div class="genome-metric-value">{top3_pct:.0f}%</div>
            <div class="genome-metric-label">Top 3 Genomes</div>
            <div class="genome-metric-hint">{concentration_hint}</div>
        </div>
        <div class="genome-metric">
            <div class="genome-metric-value">{median_reads}</div>
            <div class="genome-metric-label">Median Reads</div>
            <div class="genome-metric-hint">Per genome</div>
        </div>
    </div>
</div>
'''

GENOME_HIGHLIGHTS_TEMPLATE: str = '''
<div class="genome-highlights">
    <h4>Key Genomes</h4>
    <div class="highlights-grid">
        <div class="highlight-card top">
            <div class="highlight-icon">1</div>
            <div class="highlight-content">
                <div class="highlight-title">Most Abundant</div>
                <div class="highlight-species">{top_species}</div>
                <div class="highlight-accession">{top_accession}</div>
                <div class="highlight-stats">
                    <span class="stat">{top_reads:,} reads</span>
                    <span class="stat">{top_identity:.1f}% identity</span>
                </div>
            </div>
        </div>
        <div class="highlight-card novel">
            <div class="highlight-icon">N</div>
            <div class="highlight-content">
                <div class="highlight-title">Most Novel</div>
                <div class="highlight-species">{novel_species}</div>
                <div class="highlight-accession">{novel_accession}</div>
                <div class="highlight-stats">
                    <span class="stat">{novel_reads:,} reads</span>
                    <span class="stat">{novel_novelty:.1f} novelty</span>
                </div>
            </div>
        </div>
        <div class="highlight-card confident">
            <div class="highlight-icon">C</div>
            <div class="highlight-content">
                <div class="highlight-title">Most Confident</div>
                <div class="highlight-species">{confident_species}</div>
                <div class="highlight-accession">{confident_accession}</div>
                <div class="highlight-stats">
                    <span class="stat">{confident_reads:,} reads</span>
                    <span class="stat">{confident_identity:.1f}% identity</span>
                </div>
            </div>
        </div>
    </div>
</div>
'''

GENOME_INTERPRETATION_TEMPLATE: str = '''
<div class="genome-interpretation">
    <h4>Understanding Genome Distribution</h4>
    <div class="interp-items">
        <div class="interp-item">
            <span class="interp-label">Concentrated distribution</span>
            <span class="interp-desc">Most reads hit few genomes - sample likely contains organisms closely related to specific references</span>
        </div>
        <div class="interp-item">
            <span class="interp-label">Spread distribution</span>
            <span class="interp-desc">Reads spread across many genomes - may indicate diverse community or novel organism equidistant from multiple references</span>
        </div>
        <div class="interp-item">
            <span class="interp-label">Low identity hits</span>
            <span class="interp-desc">Genomes with lower mean identity suggest reads from more divergent organisms</span>
        </div>
    </div>
</div>
'''

# =============================================================================
# Plot Containers
# =============================================================================

PLOT_ROW_TEMPLATE: str = '''
<div class="plot-row">
{plots}
</div>
'''

PLOT_CONTAINER_TEMPLATE: str = '''
<div class="plot-container {extra_class}">
    <div class="plot-title">{title}</div>
    <div class="plot-description">{description}</div>
    <div id="{plot_id}" class="plotly-chart"></div>
</div>
'''

PLOT_CONTAINER_SIMPLE_TEMPLATE: str = '''
<div class="plot-container {extra_class}">
    <div id="{plot_id}" class="plotly-chart"></div>
</div>
'''

# =============================================================================
# Data Table
# =============================================================================

DATA_SUMMARY_TEMPLATE: str = '''
<div class="data-summary">
    <div class="data-intro">
        <h3>Classification Data</h3>
        <p>Detailed per-read classification results. Use filters to explore specific categories
           or search for individual reads. Click column headers to sort.</p>
    </div>
    <div class="data-stats">
        <div class="data-stat">
            <span class="stat-value">{total_rows:,}</span>
            <span class="stat-label">Total Reads</span>
        </div>
        <div class="data-stat known">
            <span class="stat-value">{known_count:,}</span>
            <span class="stat-label">Known</span>
        </div>
        <div class="data-stat novel">
            <span class="stat-value">{novel_count:,}</span>
            <span class="stat-label">Novel</span>
        </div>
        <div class="data-stat uncertain">
            <span class="stat-value">{uncertain_count:,}</span>
            <span class="stat-label">Uncertain</span>
        </div>
    </div>
</div>
'''

DATA_QUICK_FILTERS_TEMPLATE: str = '''
<div class="quick-filters">
    <div class="filter-row">
        <span class="filter-label">Category:</span>
        <button class="filter-chip active" data-filter="" onclick="quickFilter(this, '')">All</button>
        <button class="filter-chip known" data-filter="Known Species" onclick="quickFilter(this, 'Known Species')">Known Species ({known_count})</button>
        <button class="filter-chip novel-species" data-filter="Novel Species" onclick="quickFilter(this, 'Novel Species')">Novel Species ({novel_species_count})</button>
        <button class="filter-chip novel-genus" data-filter="Novel Genus" onclick="quickFilter(this, 'Novel Genus')">Novel Genus ({novel_genus_count})</button>
        <button class="filter-chip ambiguous" data-filter="Ambiguous" onclick="quickFilter(this, 'Ambiguous')">Ambiguous ({ambiguous_count})</button>
        <button class="filter-chip conserved" data-filter="Conserved Region" onclick="quickFilter(this, 'Conserved Region')">Conserved ({conserved_count})</button>
    </div>
    <div class="filter-row">
        <span class="filter-label">Novelty:</span>
        <button class="filter-chip range" data-range="novelty" data-min="0" data-max="5" onclick="rangeFilter(this, 'novelty', 0, 5)">Low (0-5%)</button>
        <button class="filter-chip range" data-range="novelty" data-min="5" data-max="20" onclick="rangeFilter(this, 'novelty', 5, 20)">Medium (5-20%)</button>
        <button class="filter-chip range" data-range="novelty" data-min="20" data-max="100" onclick="rangeFilter(this, 'novelty', 20, 100)">High (>20%)</button>
    </div>
    <div class="filter-row">
        <span class="filter-label">Uncertainty:</span>
        <button class="filter-chip range" data-range="uncertainty" data-min="0" data-max="2" onclick="rangeFilter(this, 'uncertainty', 0, 2)">Confident (<2%)</button>
        <button class="filter-chip range" data-range="uncertainty" data-min="2" data-max="5" onclick="rangeFilter(this, 'uncertainty', 2, 5)">Moderate (2-5%)</button>
        <button class="filter-chip range" data-range="uncertainty" data-min="5" data-max="100" onclick="rangeFilter(this, 'uncertainty', 5, 100)">Ambiguous (>5%)</button>
    </div>
    <div class="filter-row">
        <span class="filter-label">Hits:</span>
        <button class="filter-chip range" data-range="hits" data-min="0" data-max="1" onclick="rangeFilter(this, 'hits', 0, 1)">Single-hit</button>
        <button class="filter-chip range" data-range="hits" data-min="2" data-max="9999" onclick="rangeFilter(this, 'hits', 2, 9999)">Multi-hit</button>
    </div>
</div>
'''

DATA_COLUMN_GUIDE_TEMPLATE: str = '''
<details class="column-guide">
    <summary>Column Guide (click to expand)</summary>
    <div class="guide-content">
        <div class="guide-section">
            <h4>Core Metrics</h4>
            <div class="guide-item">
                <span class="guide-col">Identity %</span>
                <span class="guide-desc">Sequence similarity to best-matching reference genome (higher = more similar)</span>
            </div>
            <div class="guide-item">
                <span class="guide-col">Novelty</span>
                <span class="guide-desc">100 - Identity%. Higher values indicate more divergent sequences. <5% = known species, 5-20% = novel species, >20% = novel genus</span>
            </div>
            <div class="guide-item">
                <span class="guide-col">Uncertainty</span>
                <span class="guide-desc">{similarity_type}-based placement uncertainty. Low (<2%) = confident single placement, High (>5%) = ambiguous between multiple references</span>
            </div>
            <div class="guide-item">
                <span class="guide-col">Ambig. Hits</span>
                <span class="guide-desc">Number of reference genomes within bitscore threshold. 1 = unique placement, >1 = competing placements</span>
            </div>
            <div class="guide-item">
                <span class="guide-col">Identity Gap</span>
                <span class="guide-desc">Absolute difference in identity between best and second-best hit. Larger gaps indicate more confident placement</span>
            </div>
        </div>
        <div class="guide-section">
            <h4>Classification</h4>
            <div class="guide-item">
                <span class="guide-col">Classification</span>
                <span class="guide-desc">Taxonomic call: Known Species, Novel Species, Novel Genus, Ambiguous, or Conserved Region</span>
            </div>
            <div class="guide-item">
                <span class="guide-col">Is Novel</span>
                <span class="guide-desc">Yes if classified as Novel Species or Novel Genus</span>
            </div>
        </div>
        <div class="guide-section enhanced-guide" id="enhancedGuide" style="display:none;">
            <h4>Enhanced Scoring</h4>
            <div class="guide-item">
                <span class="guide-col">Unc. Type</span>
                <span class="guide-desc">"measured" = from {similarity_type} between competing hits, "inferred" = estimated from novelty for single-hit reads</span>
            </div>
            <div class="guide-item">
                <span class="guide-col">Inferred Unc.</span>
                <span class="guide-desc">Estimated uncertainty for single-hit reads based on novelty level (higher novelty = higher uncertainty)</span>
            </div>
            <div class="guide-item">
                <span class="guide-col">Discovery Score</span>
                <span class="guide-desc">Priority score (0-100) for novel reads. >=75 = high priority, 50-74 = moderate, <50 = low confidence</span>
            </div>
            <div class="guide-item">
                <span class="guide-col">Identity Conf.</span>
                <span class="guide-desc">Confidence in identity measurement (0-100). Based on novelty and alignment quality</span>
            </div>
            <div class="guide-item">
                <span class="guide-col">Placement Conf.</span>
                <span class="guide-desc">Confidence in genome assignment (0-100). Lower for inferred uncertainty</span>
            </div>
        </div>
    </div>
</details>
'''

DATA_TABLE_TEMPLATE: str = '''
<div class="table-container">
    <div class="table-controls">
        <div class="controls-row">
            <input type="text" class="table-search" id="tableSearch"
                   placeholder="Search reads, genomes, species..." oninput="filterTable()">
            <div class="controls-right">
                <div class="column-selector">
                    <button class="column-btn" onclick="toggleColumnMenu()">Columns</button>
                    <div class="column-menu" id="columnMenu">
                        <div class="menu-header">Show/Hide Columns</div>
                        <label><input type="checkbox" data-col="0" checked onchange="toggleColumn(0)"> Read ID</label>
                        <label><input type="checkbox" data-col="1" checked onchange="toggleColumn(1)"> Best Match</label>
                        <label><input type="checkbox" data-col="2" onchange="toggleColumn(2)"> Species</label>
                        <label><input type="checkbox" data-col="3" onchange="toggleColumn(3)"> Genus</label>
                        <label><input type="checkbox" data-col="4" checked onchange="toggleColumn(4)"> Identity %</label>
                        <label><input type="checkbox" data-col="5" checked onchange="toggleColumn(5)"> Novelty</label>
                        <label><input type="checkbox" data-col="6" checked onchange="toggleColumn(6)"> Uncertainty</label>
                        <label><input type="checkbox" data-col="7" onchange="toggleColumn(7)"> Ambiguous Hits</label>
                        <label><input type="checkbox" data-col="8" onchange="toggleColumn(8)"> Identity Gap</label>
                        <label><input type="checkbox" data-col="9" onchange="toggleColumn(9)"> Is Novel</label>
                        <label><input type="checkbox" data-col="10" checked onchange="toggleColumn(10)"> Classification</label>
                        <div class="menu-divider" id="enhancedColsDivider" style="display:none; border-top: 1px solid #ddd; margin: 0.5rem 0; padding-top: 0.5rem;"><em>Enhanced Scoring</em></div>
                        <label id="colLabel11" style="display:none;"><input type="checkbox" data-col="11" onchange="toggleColumn(11)"> Unc. Type</label>
                        <label id="colLabel12" style="display:none;"><input type="checkbox" data-col="12" onchange="toggleColumn(12)"> Inferred Unc.</label>
                        <label id="colLabel13" style="display:none;"><input type="checkbox" data-col="13" onchange="toggleColumn(13)"> Discovery Score</label>
                        <label id="colLabel14" style="display:none;"><input type="checkbox" data-col="14" onchange="toggleColumn(14)"> Identity Conf.</label>
                        <label id="colLabel15" style="display:none;"><input type="checkbox" data-col="15" onchange="toggleColumn(15)"> Placement Conf.</label>
                    </div>
                </div>
                <button class="export-btn" onclick="exportTableTSV()">Export TSV</button>
            </div>
        </div>
        <div class="filter-status" id="filterStatus">
            <span class="results-count">Showing <strong id="resultsCount">{total_rows:,}</strong> reads</span>
            <button class="clear-btn" id="clearFilters" onclick="clearAllFilters()" style="display:none;">Clear filters</button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="data-table" id="dataTable">
            <thead>
                <tr>
                    <th data-col="0" onclick="sortTable(0)">Read ID <span class="sort-icon">-</span></th>
                    <th data-col="1" onclick="sortTable(1)">Best Match <span class="sort-icon">-</span></th>
                    <th data-col="2" onclick="sortTable(2)" style="display:none;">Species <span class="sort-icon">-</span></th>
                    <th data-col="3" onclick="sortTable(3)" style="display:none;">Genus <span class="sort-icon">-</span></th>
                    <th data-col="4" onclick="sortTable(4)">Identity % <span class="sort-icon">-</span></th>
                    <th data-col="5" onclick="sortTable(5)">Novelty <span class="sort-icon">-</span></th>
                    <th data-col="6" onclick="sortTable(6)">Uncertainty <span class="sort-icon">-</span></th>
                    <th data-col="7" onclick="sortTable(7)" style="display:none;">Ambig. Hits <span class="sort-icon">-</span></th>
                    <th data-col="8" onclick="sortTable(8)" style="display:none;">Identity Gap <span class="sort-icon">-</span></th>
                    <th data-col="9" onclick="sortTable(9)" style="display:none;">Is Novel <span class="sort-icon">-</span></th>
                    <th data-col="10" onclick="sortTable(10)">Classification <span class="sort-icon">-</span></th>
                    <th data-col="11" onclick="sortTable(11)" style="display:none;">Unc. Type <span class="sort-icon">-</span></th>
                    <th data-col="12" onclick="sortTable(12)" style="display:none;">Inferred Unc. <span class="sort-icon">-</span></th>
                    <th data-col="13" onclick="sortTable(13)" style="display:none;">Discovery <span class="sort-icon">-</span></th>
                    <th data-col="14" onclick="sortTable(14)" style="display:none;">Id. Conf. <span class="sort-icon">-</span></th>
                    <th data-col="15" onclick="sortTable(15)" style="display:none;">Pl. Conf. <span class="sort-icon">-</span></th>
                </tr>
            </thead>
            <tbody id="tableBody">
{table_rows}
            </tbody>
        </table>
    </div>
    <div class="table-pagination">
        <span class="page-info" id="pageInfo">Showing 1-{page_size} of {total_rows}</span>
        <div class="page-buttons">
            <button class="page-btn" id="prevBtn" onclick="prevPage()" disabled>Previous</button>
            <span class="page-number" id="pageNumber">Page 1</span>
            <button class="page-btn" id="nextBtn" onclick="nextPage()">Next</button>
        </div>
    </div>
</div>
'''

TABLE_ROW_TEMPLATE: str = '''<tr class="data-row" data-class="{classification}">
    <td data-col="0">{read_id}</td>
    <td data-col="1">{best_match}</td>
    <td data-col="2" style="display:none;">{species}</td>
    <td data-col="3" style="display:none;">{genus}</td>
    <td data-col="4">{identity:.2f}</td>
    <td data-col="5">{novelty:.2f}</td>
    <td data-col="6">{uncertainty:.2f}</td>
    <td data-col="7" style="display:none;">{ambiguous_hits}</td>
    <td data-col="8" style="display:none;">{identity_gap}</td>
    <td data-col="9" style="display:none;">{is_novel}</td>
    <td data-col="10" class="{cell_class}">{classification}</td>
    <td data-col="11" style="display:none;">{uncertainty_type}</td>
    <td data-col="12" style="display:none;">{inferred_uncertainty}</td>
    <td data-col="13" style="display:none;">{discovery_score}</td>
    <td data-col="14" style="display:none;">{identity_confidence}</td>
    <td data-col="15" style="display:none;">{placement_confidence}</td>
</tr>'''

# =============================================================================
# Enhanced Scoring Templates
# =============================================================================

ENHANCED_SCORING_SUMMARY_TEMPLATE: str = '''
<div class="enhanced-scoring-summary">
    <div class="summary-intro">
        <h3>Enhanced Scoring Analysis</h3>
        <p class="intro-text">
            Enhanced scoring provides additional confidence metrics and helps identify
            high-priority novel discoveries. This analysis includes inferred uncertainty
            for single-hit reads and multi-dimensional confidence scores.
        </p>
    </div>

    <div class="metric-grid">
        <div class="metric-box">
            <div class="metric-title">Single-Hit Reads</div>
            <div class="metric-value">{single_hit_pct:.1f}%</div>
            <div class="metric-detail">{single_hit_count:,} of {total_reads:,} reads</div>
            <div class="metric-note">Reads with only one database hit - uncertainty is inferred from novelty level</div>
        </div>

        <div class="metric-box">
            <div class="metric-title">Mean Inferred Uncertainty</div>
            <div class="metric-value">{mean_inferred_uncertainty:.1f}%</div>
            <div class="metric-detail">For single-hit reads</div>
            <div class="metric-note">Estimated placement uncertainty when no competing hits exist</div>
        </div>

        <div class="metric-box highlight">
            <div class="metric-title">High-Priority Discoveries</div>
            <div class="metric-value">{high_priority_count:,}</div>
            <div class="metric-detail">Discovery score >= 75</div>
            <div class="metric-note">Novel reads with high confidence - prioritize for validation</div>
        </div>

        <div class="metric-box">
            <div class="metric-title">Mean Discovery Score</div>
            <div class="metric-value">{mean_discovery_score:.1f}</div>
            <div class="metric-detail">For {novel_count:,} novel reads</div>
            <div class="metric-note">Combined metric of novelty, alignment quality, and confidence</div>
        </div>
    </div>
</div>
'''

ENHANCED_SCORING_CONFIDENCE_TEMPLATE: str = '''
<div class="confidence-dimensions">
    <h3>Confidence Dimensions</h3>
    <p class="section-intro">
        Enhanced scoring separates confidence into orthogonal dimensions:
        <strong>identity confidence</strong> (how reliable is the identity measurement)
        and <strong>placement confidence</strong> (how confident is the genome assignment).
    </p>

    <div class="confidence-cards">
        <div class="confidence-card">
            <div class="card-header">Identity Confidence</div>
            <div class="card-value">{mean_identity_confidence:.1f}</div>
            <div class="card-desc">
                Higher values indicate more reliable identity measurements.
                Based on novelty level and alignment quality.
            </div>
            <div class="card-scale">
                <span class="low">Low (&lt;50)</span>
                <span class="mid">Moderate (50-75)</span>
                <span class="high">High (&gt;75)</span>
            </div>
        </div>

        <div class="confidence-card">
            <div class="card-header">Placement Confidence</div>
            <div class="card-value">{mean_placement_confidence:.1f}</div>
            <div class="card-desc">
                Higher values indicate more confident genome assignments.
                Penalized for inferred (unmeasured) uncertainty.
            </div>
            <div class="card-scale">
                <span class="low">Low (&lt;40)</span>
                <span class="mid">Moderate (40-70)</span>
                <span class="high">High (&gt;70)</span>
            </div>
        </div>

        <div class="confidence-card">
            <div class="card-header">Alignment Quality</div>
            <div class="card-value">{mean_alignment_quality:.1f}</div>
            <div class="card-desc">
                Composite score from mismatch rate, gap complexity,
                coverage, and e-value significance.
            </div>
            <div class="card-scale">
                <span class="low">Low (&lt;50)</span>
                <span class="mid">Moderate (50-75)</span>
                <span class="high">High (&gt;75)</span>
            </div>
        </div>
    </div>
</div>
'''

ENHANCED_SCORING_DISCOVERY_GUIDE_TEMPLATE: str = '''
<div class="discovery-guide">
    <h3>Discovery Score Interpretation</h3>
    <table class="guide-table">
        <thead>
            <tr>
                <th>Score Range</th>
                <th>Interpretation</th>
                <th>Recommended Action</th>
            </tr>
        </thead>
        <tbody>
            <tr class="priority-high">
                <td><strong>75-100</strong></td>
                <td>High-confidence discovery</td>
                <td>Prioritize for experimental validation (PCR, sequencing)</td>
            </tr>
            <tr class="priority-medium">
                <td><strong>50-74</strong></td>
                <td>Moderate discovery signal</td>
                <td>Include in candidate list, may need additional evidence</td>
            </tr>
            <tr class="priority-low">
                <td><strong>25-49</strong></td>
                <td>Low-confidence discovery</td>
                <td>Needs more evidence - look for corroborating reads</td>
            </tr>
            <tr class="priority-uncertain">
                <td><strong>&lt;25</strong></td>
                <td>Unreliable signal</td>
                <td>Likely artifact or database gap - do not prioritize</td>
            </tr>
        </tbody>
    </table>
</div>
'''

ENHANCED_SCORING_UNCERTAINTY_TYPES_TEMPLATE: str = '''
<div class="uncertainty-types">
    <h3>Understanding Uncertainty Types</h3>
    <div class="type-cards">
        <div class="type-card measured">
            <div class="type-header">Measured Uncertainty</div>
            <div class="type-count">{measured_count:,} reads ({measured_pct:.1f}%)</div>
            <div class="type-desc">
                Calculated from ANI between competing genome hits.
                <strong>More reliable</strong> - based on actual data.
            </div>
        </div>
        <div class="type-card inferred">
            <div class="type-header">Inferred Uncertainty</div>
            <div class="type-count">{inferred_count:,} reads ({inferred_pct:.1f}%)</div>
            <div class="type-desc">
                Estimated from novelty level for single-hit reads.
                <strong>Less reliable</strong> - no competing hits to measure.
            </div>
        </div>
    </div>
    <p class="uncertainty-note">
        <strong>Note:</strong> Single-hit reads (~{single_hit_pct:.0f}% of environmental data)
        previously reported 0% uncertainty, which conflated "no competing hits" with
        "confident placement". Inferred uncertainty provides a more honest estimate.
    </p>
</div>
'''

# =============================================================================
# JavaScript
# =============================================================================

TAB_NAVIGATION_JS: str = '''
// Tab navigation
function showTab(tabId) {
    document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');

    // Trigger Plotly resize for proper rendering
    window.dispatchEvent(new Event('resize'));
}
'''

DATA_TABLE_JS: str = '''
// Data table functionality
let currentPage = 1;
const pageSize = {page_size};
let filteredRows = [];
let allRows = [];
let currentClassFilter = '';
let currentSearchFilter = '';
let rangeFilters = {{}}; // {{novelty: {{min: 0, max: 5}}, uncertainty: {{min: 0, max: 2}}, hits: {{min: 0, max: 1}}}}

// Column visibility state (stored in localStorage)
// Includes enhanced scoring columns (11-15): uncertainty_type, inferred_uncertainty, discovery_score, identity_confidence, placement_confidence
const columnNames = ['read_id', 'best_match', 'species', 'genus', 'identity', 'novelty', 'uncertainty', 'ambiguous_hits', 'identity_gap', 'is_novel', 'classification', 'uncertainty_type', 'inferred_uncertainty', 'discovery_score', 'identity_confidence', 'placement_confidence'];
let columnVisibility = [true, true, false, false, true, true, true, false, false, false, true, false, false, false, false, false];

// Column indices for range filtering
const COL_NOVELTY = 5;
const COL_UNCERTAINTY = 6;
const COL_AMBIG_HITS = 7;

document.addEventListener('DOMContentLoaded', function() {{
    allRows = Array.from(document.querySelectorAll('.data-row'));
    filteredRows = [...allRows];

    // Load saved column visibility from localStorage
    const saved = localStorage.getItem('mdm_column_visibility_v2');
    if (saved) {{
        try {{
            const savedVis = JSON.parse(saved);
            // Merge with defaults (in case new columns were added)
            savedVis.forEach((visible, col) => {{
                if (col < columnVisibility.length) columnVisibility[col] = visible;
            }});
            // Apply saved visibility
            columnVisibility.forEach((visible, col) => {{
                const checkbox = document.querySelector(`input[data-col="${{col}}"]`);
                if (checkbox) checkbox.checked = visible;
                applyColumnVisibility(col, visible);
            }});
        }} catch (e) {{
            console.warn('Could not load column preferences');
        }}
    }}

    updatePagination();

    // Close column menu when clicking outside
    document.addEventListener('click', function(e) {{
        const menu = document.getElementById('columnMenu');
        const btn = document.querySelector('.column-btn');
        if (menu && !menu.contains(e.target) && !btn.contains(e.target)) {{
            menu.classList.remove('show');
        }}
    }});
}});

function toggleColumnMenu() {{
    const menu = document.getElementById('columnMenu');
    menu.classList.toggle('show');
}}

function toggleColumn(col) {{
    const checkbox = document.querySelector(`input[data-col="${{col}}"]`);
    const visible = checkbox.checked;
    columnVisibility[col] = visible;

    // Save to localStorage
    localStorage.setItem('mdm_column_visibility_v2', JSON.stringify(columnVisibility));

    applyColumnVisibility(col, visible);
}}

function applyColumnVisibility(col, visible) {{
    // Toggle header
    const header = document.querySelector(`th[data-col="${{col}}"]`);
    if (header) header.style.display = visible ? '' : 'none';

    // Toggle all cells in that column
    document.querySelectorAll(`td[data-col="${{col}}"]`).forEach(cell => {{
        cell.style.display = visible ? '' : 'none';
    }});
}}

function quickFilter(element, classification) {{
    currentClassFilter = classification;
    currentSearchFilter = document.getElementById('tableSearch').value.toLowerCase();

    // Update chip active states for category chips only
    document.querySelectorAll('.filter-chip[data-filter]').forEach(chip => chip.classList.remove('active'));
    if (element) element.classList.add('active');

    applyFilters();
}}

function rangeFilter(element, rangeType, min, max) {{
    // Toggle range filter
    const key = rangeType;
    const currentRange = rangeFilters[key];

    // If clicking same filter, remove it; otherwise set new filter
    if (currentRange && currentRange.min === min && currentRange.max === max) {{
        delete rangeFilters[key];
        element.classList.remove('active');
    }} else {{
        // Remove active from other chips in same range group
        document.querySelectorAll(`.filter-chip[data-range="${{rangeType}}"]`).forEach(chip => {{
            chip.classList.remove('active');
        }});
        rangeFilters[key] = {{ min: min, max: max }};
        element.classList.add('active');
    }}

    applyFilters();
}}

function filterTable() {{
    currentSearchFilter = document.getElementById('tableSearch').value.toLowerCase();
    applyFilters();
}}

function getRowValue(row, colIndex) {{
    const cell = row.querySelector(`td[data-col="${{colIndex}}"]`);
    if (!cell) return null;
    const val = parseFloat(cell.textContent);
    return isNaN(val) ? null : val;
}}

function applyFilters() {{
    filteredRows = allRows.filter(row => {{
        const text = row.textContent.toLowerCase();
        const rowClass = row.dataset.class;

        // Text search filter
        const matchSearch = !currentSearchFilter || text.includes(currentSearchFilter);

        // Classification filter (exact match)
        const matchClass = !currentClassFilter || rowClass === currentClassFilter;

        // Range filters
        let matchRanges = true;

        if (rangeFilters.novelty) {{
            const novelty = getRowValue(row, COL_NOVELTY);
            if (novelty !== null) {{
                matchRanges = matchRanges && (novelty >= rangeFilters.novelty.min && novelty < rangeFilters.novelty.max);
            }}
        }}

        if (rangeFilters.uncertainty) {{
            const uncertainty = getRowValue(row, COL_UNCERTAINTY);
            if (uncertainty !== null) {{
                matchRanges = matchRanges && (uncertainty >= rangeFilters.uncertainty.min && uncertainty < rangeFilters.uncertainty.max);
            }}
        }}

        if (rangeFilters.hits) {{
            const hits = getRowValue(row, COL_AMBIG_HITS);
            if (hits !== null) {{
                matchRanges = matchRanges && (hits >= rangeFilters.hits.min && hits <= rangeFilters.hits.max);
            }}
        }}

        return matchSearch && matchClass && matchRanges;
    }});

    currentPage = 1;
    updatePagination();
    updateFilterStatus();
}}

function clearAllFilters() {{
    currentClassFilter = '';
    currentSearchFilter = '';
    rangeFilters = {{}};
    document.getElementById('tableSearch').value = '';

    // Reset all chip active states
    document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
    // Set "All" as active
    const allChip = document.querySelector('.filter-chip[data-filter=""]');
    if (allChip) allChip.classList.add('active');

    filteredRows = [...allRows];
    currentPage = 1;
    updatePagination();
    updateFilterStatus();
}}

function updateFilterStatus() {{
    const resultsCount = document.getElementById('resultsCount');
    const clearBtn = document.getElementById('clearFilters');

    if (resultsCount) {{
        resultsCount.textContent = filteredRows.length.toLocaleString();
    }}

    const hasFilters = currentClassFilter || currentSearchFilter || Object.keys(rangeFilters).length > 0;
    if (clearBtn) {{
        clearBtn.style.display = hasFilters ? 'inline-block' : 'none';
    }}
}}

function updatePagination() {{
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const totalPages = Math.ceil(filteredRows.length / pageSize);

    allRows.forEach(row => row.style.display = 'none');
    filteredRows.slice(start, end).forEach(row => row.style.display = '');

    const showing = Math.min(end, filteredRows.length);
    const pageInfo = document.getElementById('pageInfo');
    if (pageInfo) {{
        pageInfo.textContent = `Showing ${{start + 1}}-${{showing}} of ${{filteredRows.length}}`;
    }}

    const pageNumber = document.getElementById('pageNumber');
    if (pageNumber) {{
        pageNumber.textContent = `Page ${{currentPage}} of ${{totalPages || 1}}`;
    }}

    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = end >= filteredRows.length;
}}

function nextPage() {{
    currentPage++;
    updatePagination();
}}

function prevPage() {{
    currentPage--;
    updatePagination();
}}

let sortColumn = -1;
let sortAsc = true;

function sortTable(col) {{
    if (sortColumn === col) {{
        sortAsc = !sortAsc;
    }} else {{
        sortColumn = col;
        sortAsc = true;
    }}

    filteredRows.sort((a, b) => {{
        const aCell = a.querySelector(`td[data-col="${{col}}"]`);
        const bCell = b.querySelector(`td[data-col="${{col}}"]`);
        if (!aCell || !bCell) return 0;

        const aVal = aCell.textContent;
        const bVal = bCell.textContent;

        // Try numeric comparison
        const aNum = parseFloat(aVal);
        const bNum = parseFloat(bVal);
        if (!isNaN(aNum) && !isNaN(bNum)) {{
            return sortAsc ? aNum - bNum : bNum - aNum;
        }}

        // String comparison
        return sortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    }});

    currentPage = 1;
    updatePagination();

    // Update sort indicators
    document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = '-');
    const header = document.querySelector(`th[data-col="${{col}}"]`);
    if (header) {{
        const icon = header.querySelector('.sort-icon');
        if (icon) icon.textContent = sortAsc ? '^' : 'v';
    }}
}}

function exportTableTSV() {{
    // Export only visible columns
    const visibleCols = columnVisibility.map((v, i) => v ? i : -1).filter(i => i >= 0);
    const headers = visibleCols.map(i => columnNames[i]);

    const rows = filteredRows.map(row => {{
        return visibleCols.map(col => {{
            const cell = row.querySelector(`td[data-col="${{col}}"]`);
            return cell ? cell.textContent : '';
        }}).join('\\t');
    }});

    const tsv = headers.join('\\t') + '\\n' + rows.join('\\n');
    const blob = new Blob([tsv], {{ type: 'text/tab-separated-values' }});
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'classifications_export.tsv';
    a.click();
    URL.revokeObjectURL(url);
}}
'''

# =============================================================================
# Empty/Placeholder Sections
# =============================================================================

EMPTY_SECTION_TEMPLATE: str = '''
<div class="plot-container" style="text-align: center; padding: 3rem;">
    <p style="color: var(--text-muted); font-size: 1rem;">
        {message}
    </p>
</div>
'''

ANI_NOT_PROVIDED_MESSAGE: str = "ANI matrix not provided. Use --ani option to include ANI heatmap."

RECRUITMENT_NOT_PROVIDED_MESSAGE: str = (
    "BAM file not provided. Use --bam option to include recruitment plot."
)

# =============================================================================
# Methods Section Template
# =============================================================================

METHODS_SECTION_TEMPLATE: str = '''
<div class="methods-section">
    <div class="methods-intro">
        <p>This section describes the computational methods used for classifying metagenomic reads.
        All calculations are presented with their mathematical formulations and biological interpretations.
        For complete technical details, see the
        <a href="https://github.com/FOI-Bioinformatics/metadarkmatter/blob/main/docs/METHODS.md" target="_blank">full methods documentation</a>.</p>
    </div>

    <div class="methods-toc">
        <h3>Contents</h3>
        <ol>
            <li><a href="#methods-overview">Algorithm Overview</a></li>
            <li><a href="#methods-novelty">Novelty Index</a></li>
            <li><a href="#methods-uncertainty">Placement Uncertainty</a></li>
            <li><a href="#methods-decision">Classification Decision Tree</a></li>
            <li><a href="#methods-confidence">Confidence Score</a></li>
            <li><a href="#methods-inferred">Inferred Uncertainty</a></li>
            <li><a href="#methods-thresholds">Threshold Summary</a></li>
            <li><a href="#methods-references">References</a></li>
        </ol>
    </div>

    <div class="methods-content">

        <section id="methods-overview" class="method-section">
            <h3>1. Algorithm Overview</h3>
            <p>metadarkmatter classifies metagenomic reads by combining sequence alignment scores with
            pre-computed genome similarity matrices. The core innovation is <strong>ANI-weighted placement
            uncertainty</strong>, which distinguishes confident identification of novel taxa from ambiguous
            placement within known taxa.</p>

            <div class="method-highlight">
                <strong>Key insight:</strong> A read aligning to multiple reference genomes with similar
                scores could indicate either: (1) a conserved gene shared across genera, or (2) a read
                from a species closely related to multiple references. ANI between competing genomes
                resolves this ambiguity.
            </div>

            <h4>Input Data</h4>
            <ul>
                <li><strong>Alignment results</strong> - BLAST or MMseqs2 tabular output</li>
                <li><strong>ANI matrix</strong> - Pre-computed Average Nucleotide Identity between reference genomes</li>
                <li><strong>AAI matrix</strong> (optional) - Average Amino Acid Identity for protein-level analysis</li>
            </ul>
        </section>

        <section id="methods-novelty" class="method-section">
            <h3>2. Novelty Index (N)</h3>
            <p>The Novelty Index quantifies sequence divergence from the closest reference genome.</p>

            <div class="formula-box">
                <div class="formula">N = 100 - pident<sub>top</sub></div>
                <div class="formula-legend">
                    where pident<sub>top</sub> = percent identity of the best BLAST hit (highest bitscore)
                </div>
            </div>

            <table class="methods-table">
                <thead>
                    <tr>
                        <th>Novelty Index</th>
                        <th>BLAST Identity</th>
                        <th>Biological Interpretation</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="row-known">
                        <td>N &lt; 4%</td>
                        <td>pident &gt; 96%</td>
                        <td>At or above species boundary</td>
                    </tr>
                    <tr class="row-novel-species">
                        <td>4% &le; N &lt; 20%</td>
                        <td>80% &lt; pident &le; 96%</td>
                        <td>Below species boundary (novel species candidate)</td>
                    </tr>
                    <tr class="row-novel-genus">
                        <td>20% &le; N &le; 25%</td>
                        <td>75% &le; pident &le; 80%</td>
                        <td>Genus-level divergence (novel genus candidate)</td>
                    </tr>
                    <tr class="row-unclassified">
                        <td>N &gt; 25%</td>
                        <td>pident &lt; 75%</td>
                        <td>Very high divergence</td>
                    </tr>
                </tbody>
            </table>

            <p class="methods-note"><strong>Note:</strong> Read-level BLAST identity can be 10-20% lower
            than genome-level ANI due to partial alignments. The 20% threshold for novel genus accounts
            for this systematic offset.</p>
        </section>

        <section id="methods-uncertainty" class="method-section">
            <h3>3. Placement Uncertainty (U)</h3>
            <p>Placement Uncertainty measures classification ambiguity when a read aligns to multiple
            reference genomes with similar scores.</p>

            <h4>Step 1: Identify competing hits</h4>
            <div class="formula-box">
                <div class="formula">threshold = 0.95 &times; bitscore<sub>top</sub></div>
                <div class="formula">ambiguous_hits = {hit : hit.bitscore &ge; threshold}</div>
                <div class="formula">competing_genomes = unique genomes from ambiguous_hits</div>
            </div>

            <h4>Step 2: Calculate uncertainty from ANI</h4>
            <div class="formula-box">
                <div class="formula">
                    U = 100 - max(ANI(G<sub>top</sub>, G<sub>i</sub>)) for all G<sub>i</sub> in secondary_genomes
                </div>
                <div class="formula-legend">
                    where G<sub>top</sub> = genome with highest bitscore hit
                </div>
            </div>

            <table class="methods-table">
                <thead>
                    <tr>
                        <th>Uncertainty</th>
                        <th>ANI Between Competitors</th>
                        <th>Biological Interpretation</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="row-confident">
                        <td>U &lt; 1.5%</td>
                        <td>ANI &gt; 98.5%</td>
                        <td>Same species (confident placement)</td>
                    </tr>
                    <tr class="row-boundary">
                        <td>1.5% &le; U &lt; 5%</td>
                        <td>95% &lt; ANI &le; 98.5%</td>
                        <td>Species boundary zone (ambiguous)</td>
                    </tr>
                    <tr class="row-conserved">
                        <td>U &ge; 5%</td>
                        <td>ANI &le; 95%</td>
                        <td>Different species (conserved gene region)</td>
                    </tr>
                </tbody>
            </table>

            <div class="method-highlight">
                <strong>Biological rationale:</strong> When competing genomes share high ANI (&gt;98%),
                they represent the same species and placement ambiguity reflects strain-level variation.
                When competing genomes share low ANI (&lt;95%), the read likely originates from a
                conserved gene present across multiple species.
            </div>
        </section>

        <section id="methods-decision" class="method-section">
            <h3>4. Classification Decision Tree</h3>
            <p>Classification follows a hierarchical decision tree where uncertainty takes priority over novelty:</p>

            <div class="decision-tree">
                <div class="tree-node start">Read with BLAST hits</div>
                <div class="tree-arrow">&darr;</div>
                <div class="tree-node">Calculate N and U</div>
                <div class="tree-arrow">&darr;</div>
                <div class="tree-branch">
                    <div class="tree-condition">U &ge; 5%?</div>
                    <div class="tree-yes">&rarr; YES &rarr; <span class="cat-ambiguous">AMBIGUOUS</span></div>
                </div>
                <div class="tree-arrow">&darr; NO</div>
                <div class="tree-branch">
                    <div class="tree-condition">1.5% &le; U &lt; 5%?</div>
                    <div class="tree-yes">&rarr; YES &rarr; <span class="cat-boundary">SPECIES BOUNDARY</span></div>
                </div>
                <div class="tree-arrow">&darr; NO (U &lt; 1.5%)</div>
                <div class="tree-branch">
                    <div class="tree-condition">N &lt; 4%?</div>
                    <div class="tree-yes">&rarr; YES &rarr; <span class="cat-known">KNOWN SPECIES</span></div>
                </div>
                <div class="tree-arrow">&darr; NO</div>
                <div class="tree-branch">
                    <div class="tree-condition">4% &le; N &lt; 20%?</div>
                    <div class="tree-yes">&rarr; YES &rarr; <span class="cat-novel-species">NOVEL SPECIES</span></div>
                </div>
                <div class="tree-arrow">&darr; NO</div>
                <div class="tree-branch">
                    <div class="tree-condition">20% &le; N &le; 25%?</div>
                    <div class="tree-yes">&rarr; YES &rarr; <span class="cat-novel-genus">NOVEL GENUS</span></div>
                </div>
                <div class="tree-arrow">&darr; NO</div>
                <div class="tree-node result"><span class="cat-unclassified">UNCLASSIFIED</span></div>
            </div>

            <h4>Classification Categories Summary</h4>
            <table class="methods-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Criteria</th>
                        <th>Biological Interpretation</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="cat-known">Known Species</span></td>
                        <td>N &lt; 4% AND U &lt; 1.5%</td>
                        <td>Matches characterized species</td>
                    </tr>
                    <tr>
                        <td><span class="cat-novel-species">Novel Species</span></td>
                        <td>4% &le; N &lt; 20% AND U &lt; 1.5%</td>
                        <td>Significant divergence, confident placement</td>
                    </tr>
                    <tr>
                        <td><span class="cat-novel-genus">Novel Genus</span></td>
                        <td>20% &le; N &le; 25% AND U &lt; 1.5%</td>
                        <td>Genus-level divergence, confident placement</td>
                    </tr>
                    <tr>
                        <td><span class="cat-boundary">Species Boundary</span></td>
                        <td>1.5% &le; U &lt; 5%</td>
                        <td>Matches multiple closely related species</td>
                    </tr>
                    <tr>
                        <td><span class="cat-ambiguous">Ambiguous</span></td>
                        <td>U &ge; 5%</td>
                        <td>Conserved gene or highly uncertain placement</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section id="methods-confidence" class="method-section">
            <h3>5. Confidence Score</h3>
            <p>The confidence score (0-100) quantifies classification reliability without changing the
            classification category.</p>

            <div class="formula-box">
                <div class="formula">confidence = margin_score + placement_score + alignment_score</div>
            </div>

            <h4>Component 1: Margin from threshold boundaries (0-40 points)</h4>
            <p>Measures how far the read is from classification boundaries. Reads near boundaries have
            lower margin scores.</p>

            <h4>Component 2: Placement certainty (0-40 points)</h4>
            <table class="methods-table small">
                <thead>
                    <tr><th>Ambiguous Hits</th><th>Points</th></tr>
                </thead>
                <tbody>
                    <tr><td>1</td><td>20</td></tr>
                    <tr><td>2-3</td><td>15</td></tr>
                    <tr><td>4-5</td><td>10</td></tr>
                    <tr><td>6-10</td><td>5</td></tr>
                    <tr><td>&gt;10</td><td>0</td></tr>
                </tbody>
            </table>

            <h4>Component 3: Alignment quality (0-20 points)</h4>
            <p>Based on top hit identity, rewarding higher identity alignments.</p>

            <h4>Score Interpretation</h4>
            <table class="methods-table">
                <thead>
                    <tr><th>Score</th><th>Interpretation</th><th>Recommended Action</th></tr>
                </thead>
                <tbody>
                    <tr class="priority-high"><td>80-100</td><td>High confidence</td><td>Suitable for downstream analysis</td></tr>
                    <tr class="priority-medium"><td>60-79</td><td>Moderate confidence</td><td>Review recommended</td></tr>
                    <tr class="priority-low"><td>40-59</td><td>Low confidence</td><td>Manual verification needed</td></tr>
                    <tr class="priority-uncertain"><td>&lt;40</td><td>Very low confidence</td><td>Treat with caution</td></tr>
                </tbody>
            </table>
        </section>

        <section id="methods-inferred" class="method-section">
            <h3>6. Inferred Uncertainty for Single-Hit Reads</h3>
            <p>For reads with only one BLAST hit (~70% of environmental reads), placement uncertainty
            cannot be measured from ANI between competing genomes. Instead, uncertainty is inferred
            from the novelty level.</p>

            <div class="method-highlight">
                <strong>Rationale:</strong> Higher novelty suggests either novel diversity OR database
                incompleteness, both of which increase placement uncertainty. A read with 95% identity
                to a single reference is more reliably placed than one with 85% identity.
            </div>

            <div class="formula-box">
                <div class="formula-title">Inferred Uncertainty Formula</div>
                <table class="formula-table">
                    <tr>
                        <td>N &lt; 4%</td>
                        <td>U<sub>inferred</sub> = 5.0 + N &times; 0.5</td>
                        <td>Range: 5.0-7.0%</td>
                    </tr>
                    <tr>
                        <td>4% &le; N &lt; 20%</td>
                        <td>U<sub>inferred</sub> = 7.0 + (N - 4) &times; 1.0</td>
                        <td>Range: 7.0-23.0%</td>
                    </tr>
                    <tr>
                        <td>20% &le; N &lt; 25%</td>
                        <td>U<sub>inferred</sub> = 22.5 + (N - 20) &times; 1.5</td>
                        <td>Range: 22.5-30%</td>
                    </tr>
                    <tr>
                        <td>N &ge; 25%</td>
                        <td>U<sub>inferred</sub> = 35.0</td>
                        <td>Maximum</td>
                    </tr>
                </table>
            </div>

            <h4>Single-Hit Classification Gating (Optional)</h4>
            <p>When <code>--use-inferred-for-single-hits</code> is enabled, single-hit reads with high
            inferred uncertainty are reclassified as Ambiguous. This reduces novel species overestimation
            by acknowledging that absence of competing hits does not equal confident placement.</p>
        </section>

        <section id="methods-thresholds" class="method-section">
            <h3>7. Threshold Summary</h3>

            <h4>Nucleotide Mode (Default)</h4>
            <table class="methods-table">
                <thead>
                    <tr><th>Parameter</th><th>Value</th><th>Biological Basis</th></tr>
                </thead>
                <tbody>
                    <tr><td>Species boundary (ANI)</td><td>96%</td><td>Jain et al. 2018</td></tr>
                    <tr><td>Confident placement (ANI)</td><td>&gt;98.5%</td><td>Same species threshold</td></tr>
                    <tr><td>Genus boundary (ANI)</td><td>~75-80%</td><td>Qin et al. 2014</td></tr>
                    <tr><td>Bitscore threshold</td><td>95%</td><td>Competitive recruitment</td></tr>
                </tbody>
            </table>

            <h4>Protein Mode (BLASTX + AAI)</h4>
            <p>Wider thresholds account for slower protein evolution:</p>
            <table class="methods-table">
                <thead>
                    <tr><th>Parameter</th><th>Nucleotide</th><th>Protein</th></tr>
                </thead>
                <tbody>
                    <tr><td>Known species max</td><td>4%</td><td>10%</td></tr>
                    <tr><td>Novel species range</td><td>4-20%</td><td>10-25%</td></tr>
                    <tr><td>Novel genus range</td><td>20-25%</td><td>25-40%</td></tr>
                    <tr><td>Uncertainty (confident)</td><td>&lt;1.5%</td><td>&lt;5%</td></tr>
                </tbody>
            </table>
        </section>

        <section id="methods-references" class="method-section">
            <h3>8. References</h3>
            <ol class="references-list">
                <li>
                    <strong>Jain C, Rodriguez-R LM, Phillippy AM, Konstantinidis KT, Aluru S.</strong> (2018).
                    High throughput ANI analysis of 90K prokaryotic genomes reveals clear species boundaries.
                    <em>Nature Communications</em> 9:5114.
                    <a href="https://doi.org/10.1038/s41467-018-07641-9" target="_blank">doi:10.1038/s41467-018-07641-9</a>
                </li>
                <li>
                    <strong>Goris J, Konstantinidis KT, Klappenbach JA, et al.</strong> (2007).
                    DNA-DNA hybridization values and their relationship to whole-genome sequence similarities.
                    <em>Int J Syst Evol Microbiol</em> 57:81-91.
                    <a href="https://doi.org/10.1099/ijs.0.64483-0" target="_blank">doi:10.1099/ijs.0.64483-0</a>
                </li>
                <li>
                    <strong>Konstantinidis KT, Tiedje JM.</strong> (2005).
                    Genomic insights that advance the species definition for prokaryotes.
                    <em>PNAS</em> 102:2567-2572.
                    <a href="https://doi.org/10.1073/pnas.0409727102" target="_blank">doi:10.1073/pnas.0409727102</a>
                </li>
                <li>
                    <strong>Qin QL, Xie BB, Zhang XY, et al.</strong> (2014).
                    A proposed genus boundary for the prokaryotes based on genomic insights.
                    <em>J Bacteriol</em> 196:2210-2215.
                    <a href="https://doi.org/10.1128/JB.01688-14" target="_blank">doi:10.1128/JB.01688-14</a>
                </li>
                <li>
                    <strong>Parks DH, Chuvochina M, Waite DW, et al.</strong> (2018).
                    A standardized bacterial taxonomy based on genome phylogeny substantially revises the tree of life.
                    <em>Nature Biotechnology</em> 36:996-1004.
                    <a href="https://doi.org/10.1038/nbt.4229" target="_blank">doi:10.1038/nbt.4229</a>
                </li>
                <li>
                    <strong>Riesco R, Trujillo ME.</strong> (2024).
                    Update on the proposed minimal standards for the use of genome data for the taxonomy of prokaryotes.
                    <em>Int J Syst Evol Microbiol</em> 74:006300.
                    <a href="https://doi.org/10.1099/ijsem.0.006300" target="_blank">doi:10.1099/ijsem.0.006300</a>
                </li>
            </ol>
        </section>

    </div>
</div>
'''


# =============================================================================
# Helper Functions
# =============================================================================

def get_cell_class(classification: str) -> str:
    """Get CSS class for table cell based on classification."""
    class_map = {
        "Known Species": "cell-known",
        "Novel Species": "cell-novel-species",
        "Novel Genus": "cell-novel-genus",
        "Conserved Region": "cell-conserved",
    }
    return class_map.get(classification, "")


def get_metric_color_class(metric_type: str) -> str:
    """Get CSS class for metric card based on type."""
    color_map = {
        "total": "",
        "known": "success",
        "novel_species": "warning",
        "novel_genus": "danger",
        "conserved": "info",
    }
    return color_map.get(metric_type, "")


# =============================================================================
# Phylogeny Tab Templates
# =============================================================================

PHYLOGENY_SECTION_TEMPLATE: str = '''
<div class="phylogeny-section">
    <div class="phylogeny-header">
        <h3>Phylogenetic Placement</h3>
        <p class="phylogeny-description">
            Interactive phylogenetic tree showing the placement of novel taxa relative to
            reference genomes. Novel clusters are highlighted based on their classification
            confidence. Hover over nodes for detailed information.
        </p>
    </div>

    <div class="phylogeny-controls">
        <button class="btn btn-secondary" id="toggleLayoutBtn" onclick="toggleTreeLayout()">
            Toggle Layout
        </button>
        <button class="btn btn-secondary" id="expandAllBtn" onclick="expandAllNodes()">
            Expand All
        </button>
        <button class="btn btn-secondary" id="collapseGeneraBtn" onclick="collapseToGenera()">
            Collapse to Genera
        </button>
    </div>

    <div class="phylogeny-legend">
        <div class="legend-title">Legend</div>
        <div class="legend-items">
            <div class="legend-item">
                <span class="legend-circle reference"></span>
                <span class="legend-label">Reference Genome</span>
            </div>
            <div class="legend-item">
                <span class="legend-circle novel-species"></span>
                <span class="legend-label">Novel Species</span>
            </div>
            <div class="legend-item">
                <span class="legend-circle novel-genus"></span>
                <span class="legend-label">Novel Genus</span>
            </div>
        </div>
        <div class="legend-badges">
            <span class="confidence-badge high">High Confidence</span>
            <span class="confidence-badge medium">Medium</span>
            <span class="confidence-badge low">Low</span>
        </div>
    </div>

    <div class="phylogeny-tree-container" id="phylogeny-container">
        <!-- Tree will be rendered here by D3 -->
    </div>

    <div class="phylogeny-tooltip" id="phylogeny-tooltip" style="display: none;">
        <!-- Tooltip content populated dynamically -->
    </div>

    <script>
        var TREE_DATA = {tree_data_json};
    </script>
</div>
'''

PHYLOTREE_JS_TEMPLATE: str = '''
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// Phylogenetic tree visualization using D3.js
(function() {{
    'use strict';

    // Check if tree data is available
    if (typeof TREE_DATA === 'undefined' || !TREE_DATA) {{
        console.warn('No tree data available for phylogeny visualization');
        return;
    }}

    // Configuration
    var config = {{
        width: 900,
        margin: {{ top: 20, right: 200, bottom: 20, left: 120 }},
        nodeRadius: 6,
        linkColor: '#ccc',
        novelLinkColor: '#f39c12',
        leafHeight: 20,
        minHeight: 400,
        colors: {{
            reference: '#2ecc71',
            novelSpecies: '#f39c12',
            novelGenus: '#e74c3c',
            unknown: '#95a5a6'
        }}
    }};

    var container = document.getElementById('phylogeny-container');
    if (!container) {{
        console.error('Phylogeny container not found');
        return;
    }}

    var tooltip = document.getElementById('phylogeny-tooltip');
    var currentLayout = 'cluster';

    // Get annotations and genome labels from TREE_DATA
    var annotations = (TREE_DATA && TREE_DATA.annotations) || {{}};
    var genomeLabels = (TREE_DATA && TREE_DATA.genome_labels) || {{}};

    // Helper function to look up annotation data for a node
    function getNodeAnnotation(nodeName) {{
        if (!nodeName || !annotations[nodeName]) {{
            return null;
        }}
        var ann = annotations[nodeName];
        return {{
            isNovel: ann.is_novel || false,
            nodeType: ann.type === 'novel_species' ? 'novel_species' :
                      ann.type === 'novel_genus' ? 'novel_genus' : 'reference',
            readCount: ann.read_count || 0,
            noveltyIndex: ann.mean_novelty || 0,
            confidence: typeof ann.confidence === 'string' ?
                (ann.confidence === 'High' ? 85 :
                 ann.confidence === 'Medium' ? 65 : 35) :
                (ann.confidence || 0),
            meanUncertainty: ann.mean_uncertainty || 0,
            nearestRef: ann.nearest_ref || '',
            estAni: ann.est_ani || 0
        }};
    }}

    // Parse Newick string into hierarchical structure
    function parseNewick(newick) {{
        var tokens = newick.split(/\\s*(;|\\(|\\)|,|:)\\s*/);
        var stack = [];
        var root = {{ name: '', children: [] }};
        var current = root;

        for (var i = 0; i < tokens.length; i++) {{
            var token = tokens[i];
            switch (token) {{
                case '(':
                    var newNode = {{ name: '', children: [] }};
                    current.children.push(newNode);
                    stack.push(current);
                    current = newNode;
                    break;
                case ',':
                    var sibling = {{ name: '', children: [] }};
                    stack[stack.length - 1].children.push(sibling);
                    current = sibling;
                    break;
                case ')':
                    current = stack.pop();
                    break;
                case ':':
                case ';':
                    break;
                default:
                    if (token.length > 0) {{
                        var num = parseFloat(token);
                        if (!isNaN(num)) {{
                            current.branchLength = num;
                        }} else {{
                            current.name = token;
                        }}
                    }}
            }}
        }}

        return root.children.length === 1 ? root.children[0] : root;
    }}

    // Recursively merge annotations into tree nodes
    function mergeAnnotations(node) {{
        if (node.name) {{
            var ann = getNodeAnnotation(node.name);
            if (ann) {{
                Object.assign(node, ann);
            }} else {{
                node.isNovel = false;
                node.nodeType = 'reference';
            }}
        }}
        if (node.children) {{
            node.children.forEach(mergeAnnotations);
        }}
    }}

    // Get display label for a node (uses genome_labels from metadata)
    function getDisplayLabel(name) {{
        if (!name) return '';
        var label = genomeLabels[name] || name;
        if (label.length > 40) return label.substring(0, 37) + '...';
        return label;
    }}

    // Toggle collapse/expand of a node's children
    function toggleNode(d) {{
        if (d.children) {{
            d._children = d.children;
            d.children = null;
        }} else if (d._children) {{
            d.children = d._children;
            d._children = null;
        }}
    }}

    // Count visible leaves in the tree data
    function countLeaves(node) {{
        if (!node.children || node.children.length === 0) return 1;
        var count = 0;
        node.children.forEach(function(c) {{ count += countLeaves(c); }});
        return count;
    }}

    // Count all descendants (including hidden) of a node
    function countDescendants(node) {{
        var count = 0;
        var ch = node.children || node._children || [];
        ch.forEach(function(c) {{ count += 1 + countDescendants(c); }});
        return count;
    }}

    // Parse tree data
    var treeData;
    if (TREE_DATA.newick) {{
        treeData = parseNewick(TREE_DATA.newick);
    }} else if (typeof TREE_DATA === 'string') {{
        treeData = parseNewick(TREE_DATA);
    }} else {{
        treeData = TREE_DATA;
    }}

    mergeAnnotations(treeData);

    // SVG setup with dynamic height
    var dynamicHeight = Math.max(config.minHeight, countLeaves(treeData) * config.leafHeight);
    var svgEl = d3.select(container)
        .append('svg')
        .attr('width', config.width)
        .attr('height', dynamicHeight);
    var svg = svgEl.append('g')
        .attr('transform', 'translate(' + config.margin.left + ',' + config.margin.top + ')');

    // Tree layout
    var treeLayout = d3.cluster()
        .size([dynamicHeight - config.margin.top - config.margin.bottom,
               config.width - config.margin.left - config.margin.right]);
    var root;

    // Curved link path generator
    function linkPath(d) {{
        return 'M' + d.source.y + ',' + d.source.x +
               'C' + (d.source.y + d.target.y) / 2 + ',' + d.source.x +
               ' ' + (d.source.y + d.target.y) / 2 + ',' + d.target.x +
               ' ' + d.target.y + ',' + d.target.x;
    }}

    // Tooltip display
    function showTooltip(event, d) {{
        if (!tooltip) return;
        var name = d.data.name || 'Internal node';
        var label = genomeLabels[name] || name;
        var content = '<strong>' + label + '</strong>';
        if (d.data.readCount) {{
            content += '<br>Reads: ' + d.data.readCount;
        }}
        if (d.data.noveltyIndex !== undefined && d.data.noveltyIndex > 0) {{
            content += '<br>Novelty: ' + d.data.noveltyIndex.toFixed(1) + '%';
        }}
        if (d.data.confidence !== undefined && d.data.confidence > 0) {{
            content += '<br>Confidence: ' + d.data.confidence.toFixed(0);
        }}
        if (d.data.nodeType && d.data.nodeType !== 'reference') {{
            content += '<br>Type: ' + d.data.nodeType.replace(/_/g, ' ');
        }}
        if (d.data._children) {{
            content += '<br><em>' + countDescendants(d.data) + ' nodes collapsed</em>';
        }}
        tooltip.innerHTML = content;
        tooltip.style.display = 'block';
        tooltip.style.left = (event.pageX + 10) + 'px';
        tooltip.style.top = (event.pageY - 10) + 'px';
    }}

    function hideTooltip() {{
        if (tooltip) tooltip.style.display = 'none';
    }}

    // Central update function: recomputes layout and redraws the tree
    function updateTree() {{
        dynamicHeight = Math.max(config.minHeight, countLeaves(treeData) * config.leafHeight);
        svgEl.attr('height', dynamicHeight);
        treeLayout.size([dynamicHeight - config.margin.top - config.margin.bottom,
                         config.width - config.margin.left - config.margin.right]);

        root = d3.hierarchy(treeData);
        treeLayout(root);

        // Clear and redraw
        svg.selectAll('*').remove();

        // Draw links
        svg.selectAll('.link')
            .data(root.links())
            .enter()
            .append('path')
            .attr('class', 'link')
            .attr('d', linkPath)
            .style('fill', 'none')
            .style('stroke', function(d) {{
                return (d.target.data && d.target.data.isNovel) ? config.novelLinkColor : config.linkColor;
            }})
            .style('stroke-width', function(d) {{
                return (d.target.data && d.target.data.isNovel) ? '2px' : '1.5px';
            }})
            .style('stroke-dasharray', function(d) {{
                return (d.target.data && d.target.data.isNovel) ? '5,3' : 'none';
            }});

        // Draw nodes
        var node = svg.selectAll('.node')
            .data(root.descendants())
            .enter()
            .append('g')
            .attr('class', function(d) {{
                var cls = 'node';
                if (d.data.isNovel) cls += ' novel';
                if (!d.children && !d.data._children) cls += ' leaf';
                else cls += ' internal';
                return cls;
            }})
            .attr('transform', function(d) {{
                return 'translate(' + d.y + ',' + d.x + ')';
            }})
            .style('cursor', function(d) {{
                return (d.children || d.data._children) ? 'pointer' : 'default';
            }})
            .on('click', function(event, d) {{
                if (d.children || d.data._children) {{
                    toggleNode(d.data);
                    updateTree();
                }}
            }})
            .on('mouseover', showTooltip)
            .on('mouseout', hideTooltip);

        // Node circles
        node.append('circle')
            .attr('r', function(d) {{
                var rc = d.data.readCount || 0;
                if (rc > 100) return config.nodeRadius + 3;
                if (rc > 10) return config.nodeRadius + 1;
                return config.nodeRadius;
            }})
            .style('fill', function(d) {{
                if (!d.data) return config.colors.unknown;
                if (d.data.nodeType === 'novel_genus') return config.colors.novelGenus;
                if (d.data.nodeType === 'novel_species') return config.colors.novelSpecies;
                if (d.data.nodeType === 'reference') return config.colors.reference;
                return config.colors.unknown;
            }})
            .style('stroke', '#fff')
            .style('stroke-width', '1.5px');

        // Leaf labels with species names from genome_labels
        node.filter(function(d) {{ return !d.children && !d.data._children; }})
            .append('text')
            .attr('dy', '0.35em')
            .attr('x', 10)
            .style('font-size', '10px')
            .style('font-family', 'sans-serif')
            .text(function(d) {{ return getDisplayLabel(d.data.name); }});

        // Collapsed node indicators
        node.filter(function(d) {{ return d.data._children; }})
            .append('text')
            .attr('dy', '0.35em')
            .attr('x', 10)
            .style('font-size', '9px')
            .style('font-style', 'italic')
            .style('fill', '#999')
            .text(function(d) {{
                return '[' + countDescendants(d.data) + ' nodes]';
            }});

        // Confidence badges for novel nodes
        node.filter(function(d) {{ return d.data && d.data.isNovel; }})
            .append('text')
            .attr('class', 'confidence-badge')
            .attr('dy', '-12')
            .attr('dx', '-5')
            .style('font-size', '8px')
            .style('fill', function(d) {{
                var c = d.data.confidence || 0;
                if (c >= 75) return '#2ecc71';
                if (c >= 50) return '#f39c12';
                return '#e74c3c';
            }})
            .text(function(d) {{
                var c = d.data.confidence || 0;
                if (c >= 75) return 'H';
                if (c >= 50) return 'M';
                return 'L';
            }});
    }}

    // Initial render
    updateTree();

    // --- Button controls ---

    // Toggle between cluster (dendrogram) and tree (cladogram) layouts
    window.toggleTreeLayout = function() {{
        var iw = config.width - config.margin.left - config.margin.right;
        var ih = dynamicHeight - config.margin.top - config.margin.bottom;
        if (currentLayout === 'cluster') {{
            treeLayout = d3.tree().size([ih, iw]);
            currentLayout = 'tree';
        }} else {{
            treeLayout = d3.cluster().size([ih, iw]);
            currentLayout = 'cluster';
        }}
        updateTree();
    }};

    // Expand all collapsed subtrees
    window.expandAllNodes = function() {{
        function expandAll(node) {{
            if (node._children) {{
                node.children = node._children;
                node._children = null;
            }}
            if (node.children) node.children.forEach(expandAll);
        }}
        expandAll(treeData);
        updateTree();
    }};

    // Collapse internal subtrees that contain no novel nodes
    window.collapseToGenera = function() {{
        function hasNovelDescendant(node) {{
            if (node.isNovel) return true;
            var ch = node.children || node._children || [];
            for (var i = 0; i < ch.length; i++) {{
                if (hasNovelDescendant(ch[i])) return true;
            }}
            return false;
        }}
        function collapseIfSafe(node) {{
            // Ensure children are visible for traversal
            if (node._children) {{
                node.children = node._children;
                node._children = null;
            }}
            if (node.children) {{
                node.children.forEach(collapseIfSafe);
                // Collapse if no novel descendants and more than 2 total descendants
                if (!hasNovelDescendant(node) && countDescendants(node) > 2) {{
                    node._children = node.children;
                    node.children = null;
                }}
            }}
        }}
        // Don't collapse root itself
        if (treeData.children) {{
            treeData.children.forEach(collapseIfSafe);
        }}
        updateTree();
    }};

}})();
</script>
'''

PHYLOGENY_NOT_PROVIDED_MESSAGE: str = (
    "Phylogenetic tree not provided. Use --tree option with a Newick file "
    "to include the phylogeny visualization."
)


# =============================================================================
# Bayesian Confidence Templates
# =============================================================================

BAYESIAN_SUMMARY_TEMPLATE: str = '''
<div class="enhanced-scoring-summary">
    <div class="summary-intro">
        <h3>Bayesian Posterior Analysis</h3>
        <p class="intro-text">
            Bayesian classification assigns posterior probabilities to each category
            rather than hard labels. Near threshold boundaries, posteriors are split
            (e.g., 55% Novel Species, 40% Known Species), making classification
            uncertainty explicit. Posterior entropy measures overall confidence:
            low entropy indicates a clear assignment, high entropy indicates ambiguity.
        </p>
    </div>

    <div class="metric-grid">
        <div class="metric-box">
            <div class="metric-title">Mean Posterior Entropy</div>
            <div class="metric-value">{mean_entropy:.2f}</div>
            <div class="metric-detail">Range: 0 (certain) to 2.58 (uniform over 6 categories)</div>
            <div class="metric-note">Lower values indicate more confident classifications overall</div>
        </div>

        <div class="metric-box highlight">
            <div class="metric-title">High-Confidence Reads</div>
            <div class="metric-value">{high_confidence_pct:.1f}%</div>
            <div class="metric-detail">{high_confidence_count:,} reads with entropy &lt; 1.0</div>
            <div class="metric-note">Reads where one category clearly dominates the posterior</div>
        </div>

        <div class="metric-box">
            <div class="metric-title">Bayesian-Legacy Agreement</div>
            <div class="metric-value">{map_agreement_pct:.1f}%</div>
            <div class="metric-detail">{map_agreement_count:,} of {total_reads:,} reads</div>
            <div class="metric-note">Reads where the Bayesian primary call matches the legacy threshold call</div>
        </div>

        <div class="metric-box">
            <div class="metric-title">Boundary Reads</div>
            <div class="metric-value">{boundary_pct:.1f}%</div>
            <div class="metric-detail">{boundary_count:,} reads with entropy &gt; 1.5</div>
            <div class="metric-note">Reads near classification boundaries where multiple categories are plausible</div>
        </div>
    </div>
</div>
'''

FAMILY_VALIDATION_SECTION_TEMPLATE: str = '''
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{validated_pct:.1f}%</div>
        <div class="stat-label">Family Validated</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{off_target_count:,}</div>
        <div class="stat-label">Off-target Reads</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{off_target_pct:.1f}%</div>
        <div class="stat-label">Off-target Rate</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{target_family}</div>
        <div class="stat-label">Target Family</div>
    </div>
</div>
<h3>Family Bitscore Ratio Distribution</h3>
<div class="plot-container" id="family-ratio-histogram"></div>
<h3>In-Family vs Off-Target</h3>
<div class="plot-container" id="family-pie-chart"></div>
{borderline_analysis}
{external_families_table}
'''

BORDERLINE_ANALYSIS_TEMPLATE: str = '''
<h3>Off-Target Reads: Would-Be Classification</h3>
<p>Shows where off-target reads would fall in the novelty-uncertainty classification
space if they had been retained as in-family. Reads in the Novel Species or Novel Genus
zones may represent within-family diversity incorrectly flagged as off-target.</p>
<div class="borderline-cards">
    <div class="borderline-card">
        <div class="card-count">{known_count:,}</div>
        <div class="card-pct">{known_pct:.1f}%</div>
        <div class="card-label">Known Species</div>
        <div class="card-desc">In-family novelty &lt; {novelty_known_max}%</div>
    </div>
    <div class="borderline-card{novel_sp_highlight}">
        <div class="card-count">{novel_sp_count:,}</div>
        <div class="card-pct">{novel_sp_pct:.1f}%</div>
        <div class="card-label">Novel Species</div>
        <div class="card-desc">{novelty_known_max}% - {novelty_novel_sp_max}% novelty</div>
    </div>
    <div class="borderline-card{novel_gen_highlight}">
        <div class="card-count">{novel_gen_count:,}</div>
        <div class="card-pct">{novel_gen_pct:.1f}%</div>
        <div class="card-label">Novel Genus</div>
        <div class="card-desc">{novelty_novel_sp_max}% - {novelty_novel_gen_max}% novelty</div>
    </div>
    <div class="borderline-card">
        <div class="card-count">{divergent_count:,}</div>
        <div class="card-pct">{divergent_pct:.1f}%</div>
        <div class="card-label">Very Divergent</div>
        <div class="card-desc">&gt; {novelty_novel_gen_max}% novelty</div>
    </div>
</div>
<div class="plot-container" id="family-novelty-scatter"></div>
'''

BAYESIAN_INTERPRETATION_TEMPLATE: str = '''
<div class="discovery-guide">
    <h3>Interpreting Bayesian Posteriors</h3>
    <div class="guide-grid">
        <div class="guide-item">
            <div class="guide-label">Entropy &lt; 0.5</div>
            <div class="guide-desc">
                <strong>Very confident.</strong> One category holds &gt;85% of the posterior mass.
                The classification is robust to threshold perturbation.
            </div>
        </div>
        <div class="guide-item">
            <div class="guide-label">Entropy 0.5 - 1.0</div>
            <div class="guide-desc">
                <strong>Confident.</strong> The MAP category is the clear winner, though a secondary
                category holds appreciable probability. Classification is likely stable.
            </div>
        </div>
        <div class="guide-item">
            <div class="guide-label">Entropy 1.0 - 1.5</div>
            <div class="guide-desc">
                <strong>Moderate uncertainty.</strong> Two or more categories share significant posterior
                mass. The read lies near a classification boundary and results are
                threshold-dependent.
            </div>
        </div>
        <div class="guide-item">
            <div class="guide-label">Entropy &gt; 1.5</div>
            <div class="guide-desc">
                <strong>High uncertainty.</strong> Posterior mass is spread across multiple categories.
                Consider these reads as boundary cases requiring additional evidence.
            </div>
        </div>
    </div>
</div>
'''

CONFIDENCE_SUMMARY_TEMPLATE: str = '''
<div class="enhanced-scoring-summary">
    <div class="summary-intro">
        <h3>Classification Confidence Overview</h3>
        <p class="intro-text">
            Bayesian classification assigns posterior probabilities to each category.
            Posterior entropy measures overall confidence: low entropy indicates a clear
            assignment, high entropy indicates ambiguity. Discovery scores prioritize
            novel reads by combining novelty, alignment quality, and confidence.
        </p>
    </div>

    <div class="metric-grid">
        <div class="metric-box">
            <div class="metric-title">Mean Posterior Entropy</div>
            <div class="metric-value">{mean_entropy:.2f}</div>
            <div class="metric-detail">Range: 0 (certain) to 2.58 (uniform over 6 categories)</div>
            <div class="metric-note">Lower values indicate more confident classifications</div>
        </div>

        <div class="metric-box highlight">
            <div class="metric-title">High-Confidence Reads</div>
            <div class="metric-value">{high_confidence_pct:.1f}%</div>
            <div class="metric-detail">{high_confidence_count:,} reads with entropy &lt; 1.0</div>
            <div class="metric-note">Reads where one category clearly dominates</div>
        </div>

        <div class="metric-box">
            <div class="metric-title">Bayesian-Legacy Agreement</div>
            <div class="metric-value">{map_agreement_pct:.1f}%</div>
            <div class="metric-detail">{map_agreement_count:,} of {total_reads:,} reads</div>
            <div class="metric-note">Bayesian primary call matches legacy threshold call</div>
        </div>

        <div class="metric-box">
            <div class="metric-title">Single-Hit Reads</div>
            <div class="metric-value">{single_hit_pct:.1f}%</div>
            <div class="metric-detail">{single_hit_count:,} of {total_reads:,} reads</div>
            <div class="metric-note">Uncertainty is inferred from novelty level</div>
        </div>

        <div class="metric-box">
            <div class="metric-title">Mean Discovery Score</div>
            <div class="metric-value">{mean_discovery_score:.1f}</div>
            <div class="metric-detail">For {novel_count:,} novel reads</div>
            <div class="metric-note">Combined novelty, alignment quality, and confidence</div>
        </div>

        <div class="metric-box">
            <div class="metric-title">Boundary Reads</div>
            <div class="metric-value">{boundary_pct:.1f}%</div>
            <div class="metric-detail">{boundary_count:,} reads with entropy &gt; 1.5</div>
            <div class="metric-note">Near boundaries where multiple categories are plausible</div>
        </div>
    </div>
</div>
'''
