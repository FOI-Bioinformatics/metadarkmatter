"""
Multi-sample comparison report generator.

Generates HTML reports comparing classification results across multiple samples,
enabling cross-sample analysis of microbial diversity patterns.
"""

from __future__ import annotations

import logging
from dataclasses import dataclass
from datetime import datetime
from pathlib import Path
from typing import Any

import polars as pl

logger = logging.getLogger(__name__)

from metadarkmatter.cli.utils import extract_sample_name
from metadarkmatter.core.io_utils import read_dataframe
from metadarkmatter.visualization.plots.base import (
    PlotConfig,
    format_count,
)
from metadarkmatter.visualization.plots.multi_sample import (
    MultiSampleBarChart,
    MultiSampleHeatmap,
    MultiSampleNoveltyComparison,
    MultiSampleScatterMatrix,
    MultiSampleTimeSeries,
)
from metadarkmatter.visualization.report.styles import get_css_styles

# Version for report footer
try:
    from metadarkmatter import __version__
except ImportError:
    __version__ = "0.1.0"


# Simplified templates for multi-sample report
MULTI_REPORT_TEMPLATE = '''<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    <style>
{css_styles}
    </style>
</head>
<body>
    <header class="report-header">
        <h1>{title}</h1>
        <div class="metadata">
            <span>Samples: <strong>{num_samples}</strong></span>
            <span>Total Reads: <strong>{total_reads}</strong></span>
            <span>Generated: <strong>{timestamp}</strong></span>
        </div>
    </header>

    <main class="report-content">
        <section class="tab-section active">
            <h2 class="section-title">Multi-Sample Comparison</h2>
{content}
        </section>
    </main>

    <footer class="report-footer">
        <p>Generated by <strong>Metadarkmatter</strong> v{version}</p>
        <p>ANI-weighted taxonomic placement for metagenomic analysis</p>
    </footer>

    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
{plotly_js}
</body>
</html>
'''

SAMPLE_TABLE_TEMPLATE = '''
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>Sample</th>
                <th>Total Reads</th>
                <th>Known Species</th>
                <th>Novel Species</th>
                <th>Novel Genus</th>
                <th>Conserved</th>
                <th>Novel %</th>
                <th>Mean Novelty</th>
            </tr>
        </thead>
        <tbody>
{rows}
        </tbody>
    </table>
</div>
'''

SAMPLE_ROW_TEMPLATE = '''<tr>
    <td><strong>{name}</strong></td>
    <td>{total}</td>
    <td class="cell-known">{known}</td>
    <td class="cell-novel-species">{novel_sp}</td>
    <td class="cell-novel-genus">{novel_gen}</td>
    <td class="cell-conserved">{conserved}</td>
    <td>{novel_pct:.1f}%</td>
    <td>{mean_novelty:.2f}</td>
</tr>'''

PLOT_CONTAINER_TEMPLATE = '''
<div class="plot-container full-width">
    <div class="plot-title">{title}</div>
    <div class="plot-description">{description}</div>
    <div id="{plot_id}" class="plotly-chart"></div>
</div>
'''


@dataclass
class MultiSampleConfig:
    """Configuration for multi-sample report generation."""

    title: str = "Multi-Sample Comparison Report"
    theme: str = "light"
    plot_config: PlotConfig | None = None


class MultiSampleReportGenerator:
    """
    Generates comparison reports for multiple samples.

    Creates visualizations comparing:
    - Classification proportions across samples
    - Novelty distributions
    - Diversity metrics
    """

    def __init__(
        self,
        sample_data: dict[str, pl.DataFrame],
        config: MultiSampleConfig | None = None,
    ) -> None:
        """
        Initialize multi-sample report generator.

        Args:
            sample_data: Dictionary mapping sample names to classification DataFrames.
                Each DataFrame should have columns: taxonomic_call, novelty_index,
                placement_uncertainty, top_hit_identity
            config: Report configuration
        """
        self.sample_data = sample_data
        self.config = config or MultiSampleConfig()
        self.plot_config = self.config.plot_config or PlotConfig(width=1000, height=500)

        # Compute summaries for each sample
        self.summaries: dict[str, dict[str, Any]] = {}
        for name, df in sample_data.items():
            self.summaries[name] = self._compute_summary(df)

        # Store plot data for JS rendering
        self._plot_data: dict[str, str] = {}

    def _compute_summary(self, df: pl.DataFrame) -> dict[str, Any]:
        """Compute summary statistics for a sample."""
        counts = df.group_by("taxonomic_call").len().to_dict(as_series=False)
        count_map = dict(zip(counts.get("taxonomic_call", []), counts.get("len", []), strict=True))

        total = len(df)
        known = count_map.get("Known Species", 0)
        novel_sp = count_map.get("Novel Species", 0)
        novel_gen = count_map.get("Novel Genus", 0)
        conserved = count_map.get("Conserved Region", 0)

        return {
            "total_reads": total,
            "known_species": known,
            "novel_species": novel_sp,
            "novel_genus": novel_gen,
            "conserved_regions": conserved,
            "novel_percentage": (novel_sp + novel_gen) / total * 100 if total > 0 else 0,
            "mean_novelty_index": df["novelty_index"].mean() or 0.0,
            "mean_placement_uncertainty": df["placement_uncertainty"].mean() or 0.0,
        }

    def generate(self, output_path: Path | str) -> None:
        """Generate and save the multi-sample report."""
        html = self._build_html()

        output_path = Path(output_path)
        output_path.parent.mkdir(parents=True, exist_ok=True)
        output_path.write_text(html, encoding="utf-8")

    def _build_html(self) -> str:
        """Build the complete HTML report."""
        content_parts = []

        # Summary table
        content_parts.append(self._build_summary_table())

        # Stacked bar chart - classification proportions
        stacked_bar = MultiSampleBarChart(
            self.summaries,
            config=self.plot_config,
            stacked=True,
            normalize=True,
            title="Classification Distribution by Sample",
        )
        stacked_id = "plot-stacked-bar"
        self._register_plot(stacked_id, stacked_bar.create_figure())
        content_parts.append(PLOT_CONTAINER_TEMPLATE.format(
            title="Classification Distribution",
            description=(
                "Stacked bar chart showing the proportion of reads "
                "in each classification category for each sample."
            ),
            plot_id=stacked_id,
        ))

        # Grouped bar chart
        grouped_bar = MultiSampleBarChart(
            self.summaries,
            config=self.plot_config,
            stacked=False,
            normalize=True,
            title="Classification Comparison by Category",
        )
        grouped_id = "plot-grouped-bar"
        self._register_plot(grouped_id, grouped_bar.create_figure())
        content_parts.append(PLOT_CONTAINER_TEMPLATE.format(
            title="Classification Comparison",
            description="Grouped bar chart comparing classification proportions across samples.",
            plot_id=grouped_id,
        ))

        # Heatmap
        heatmap = MultiSampleHeatmap(
            self.summaries,
            config=PlotConfig(width=800, height=max(300, 50 * len(self.summaries))),
            title="Sample-Category Heatmap",
        )
        heatmap_id = "plot-heatmap"
        self._register_plot(heatmap_id, heatmap.create_figure())
        content_parts.append(PLOT_CONTAINER_TEMPLATE.format(
            title="Classification Heatmap",
            description=(
                "Heatmap showing classification proportions (%) "
                "for each sample-category combination."
            ),
            plot_id=heatmap_id,
        ))

        # Sample diversity scatter
        scatter = MultiSampleScatterMatrix(
            self.summaries,
            config=self.plot_config,
            title="Sample Diversity Overview",
        )
        scatter_id = "plot-diversity-scatter"
        self._register_plot(scatter_id, scatter.create_figure())
        content_parts.append(PLOT_CONTAINER_TEMPLATE.format(
            title="Sample Diversity Overview",
            description=(
                "Scatter plot showing each sample positioned by mean novelty (x) "
                "vs mean uncertainty (y). Marker size reflects total reads."
            ),
            plot_id=scatter_id,
        ))

        # Novelty box plot
        novelty_box = MultiSampleNoveltyComparison(
            self.sample_data,
            config=self.plot_config,
            title="Novelty Index Distribution by Sample",
        )
        novelty_id = "plot-novelty-box"
        self._register_plot(novelty_id, novelty_box.create_figure())
        content_parts.append(PLOT_CONTAINER_TEMPLATE.format(
            title="Novelty Index Comparison",
            description=(
                "Box plots showing the distribution of novelty index values "
                "for each sample."
            ),
            plot_id=novelty_id,
        ))

        # Novel diversity trend
        trend = MultiSampleTimeSeries(
            self.summaries,
            config=self.plot_config,
            metric="novel_percentage",
            title="Novel Diversity Across Samples",
        )
        trend_id = "plot-novel-trend"
        self._register_plot(trend_id, trend.create_figure())
        content_parts.append(PLOT_CONTAINER_TEMPLATE.format(
            title="Novel Diversity Trend",
            description=(
                "Line plot showing the percentage of novel reads "
                "(Novel Species + Novel Genus) for each sample in order."
            ),
            plot_id=trend_id,
        ))

        content = "\n".join(content_parts)

        # Calculate totals
        total_reads = sum(s["total_reads"] for s in self.summaries.values())

        # Build Plotly JS
        plotly_js = self._build_plotly_js()

        return MULTI_REPORT_TEMPLATE.format(
            title=self.config.title,
            num_samples=len(self.sample_data),
            total_reads=format_count(total_reads),
            timestamp=datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            version=__version__,
            css_styles=get_css_styles(self.config.theme),
            content=content,
            plotly_js=plotly_js,
        )

    def _build_summary_table(self) -> str:
        """Build the sample summary table."""
        rows = []
        for name, summary in self.summaries.items():
            rows.append(SAMPLE_ROW_TEMPLATE.format(
                name=name,
                total=format_count(summary["total_reads"]),
                known=format_count(summary["known_species"]),
                novel_sp=format_count(summary["novel_species"]),
                novel_gen=format_count(summary["novel_genus"]),
                conserved=format_count(summary["conserved_regions"]),
                novel_pct=summary["novel_percentage"],
                mean_novelty=summary["mean_novelty_index"],
            ))

        return SAMPLE_TABLE_TEMPLATE.format(rows="\n".join(rows))

    def _register_plot(self, plot_id: str, fig) -> None:
        """Register a plot for later JS initialization."""
        self._plot_data[plot_id] = fig.to_json()

    def _build_plotly_js(self) -> str:
        """Build Plotly.js initialization code."""
        js_lines = ["<script>"]
        js_lines.append("document.addEventListener('DOMContentLoaded', function() {")

        for plot_id, plot_json in self._plot_data.items():
            var_name = plot_id.replace("-", "_")
            js_lines.append(f"  var data_{var_name} = {plot_json};")
            js_lines.append(
                f"  Plotly.newPlot('{plot_id}', "
                f"data_{var_name}.data, "
                f"data_{var_name}.layout, "
                f"{{responsive: true}});"
            )

        js_lines.append("});")
        js_lines.append("</script>")

        return "\n".join(js_lines)


def generate_multi_sample_report(
    input_dir: Path | str,
    output_path: Path | str,
    pattern: str = "*classifications*.csv",
    title: str = "Multi-Sample Comparison Report",
    theme: str = "light",
) -> int:
    """
    Generate a multi-sample comparison report from a directory of classification files.

    Args:
        input_dir: Directory containing classification CSV files
        output_path: Output path for HTML report
        pattern: Glob pattern to match classification files
        title: Report title
        theme: Color theme ('light' or 'dark')

    Returns:
        Number of samples processed
    """
    input_dir = Path(input_dir)
    files = sorted(input_dir.glob(pattern))

    if not files:
        raise ValueError(f"No files found matching pattern '{pattern}' in {input_dir}")

    # Load all samples
    sample_data: dict[str, pl.DataFrame] = {}
    for f in files:
        sample_name = extract_sample_name(f)
        try:
            df = read_dataframe(f)
            sample_data[sample_name] = df
        except Exception as e:
            logger.warning("Could not load %s: %s", f, e)

    if not sample_data:
        raise ValueError("No valid classification files could be loaded")

    # Generate report
    config = MultiSampleConfig(title=title, theme=theme)
    generator = MultiSampleReportGenerator(sample_data, config=config)
    generator.generate(output_path)

    return len(sample_data)
